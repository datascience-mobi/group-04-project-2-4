---
title: "Data analysis: Project 2 Group 4"
output:
  html_document:
    df_print: paged
  pdf_document: default
---
# Molecular Biotechnology, 4th term, Summer 2019
### Anna, Ann-Sophie und Jana

```{r, include=FALSE}
#Load required packages
library(knitr)
#for pdf output load tinytex
#install.packages("tinytex")
#tinytex::install_tinytex()
library(tinytex)
```

```{r setup, include=FALSE} 
#code and output not included in final file
knitr::opts_chunk$set(cache = TRUE, echo = TRUE, warning = FALSE)
knitr::opts_chunk$set(fig.width = 9, fig.height = 6, fig.align = "center")
```

First of all, a broad analysis containing all samples of the NCI60 panel with 15 different cancer drugs was performed. In the specific analysis we focused on the drug erlotinib, which is an inhibitor of EGFR. Three milestones were defined to analyse which pathways are mostly regulated due to the drug treatment. The first one included finding the celllines which have the strongest fold change and the most regulated genes (biomarkers). Secondly, the correlation between the drug sensitivity of the various celllines (GI50) and the EGR1 expression was analysed. In the last part, we analysed the effect of erlotinib on different pathways using the package PROGENY and illustrating the fold change in gene expression due to the drug in a heatmap. 

### Load data
Firstly, the data generated from the NCI60 cellline panel is downloaded and the various tables are saved as data frames. 

```{r }
NCI_TPW_gep_treated <- readRDS(url("https://ndownloader.figshare.com/files/14720180?private_link=db1411debcfbe2618d2f"))
NCI_TPW_gep_untreated <- readRDS(url("https://ndownloader.figshare.com/files/14720183?private_link=db1411debcfbe2618d2f"))
NCI_TPW_metadata <- read.delim("https://ndownloader.figshare.com/files/14720186?private_link=db1411debcfbe2618d2f")
NegLogGI50 <- readRDS(url("https://ndownloader.figshare.com/files/ 14720210?private_link=074e0120fe5e682f3d14"))
CCLE_basalexpression <- readRDS(url("https://ndownloader.figshare.com/files/14770127?private_link=fc0c71246dc192982a3c"))
CCLE_copynumber <- readRDS(url("https://ndownloader.figshare.com/files/14770130?private_link=fc0c71246dc192982a3c"))
CCLE_mutations <- readRDS(url("https://ndownloader.figshare.com/files/14770133?private_link=fc0c71246dc192982a3c"))
cellline_annotation <-read.delim("https://ndownloader.figshare.com/files/14768981?private_link=efb6a529eaf2d4dc6432")
drug_annotation <- read.delim("https://ndownloader.figshare.com/files/14768984?private_link=efb6a529eaf2d4dc6432")
```

##1. Broad analysis

### Data preparation and annotation

**Calculate fold change** due to drug treatment  
The begin of the project includes some preparation of the data and annotation. Since the gene expression values are already logarithmic, the fold change caused by the drug can be calculated by substracting the untreated values (as a control of normal gene expression for each gene in each cellline) from the treated ones. 

```{r }
fold_changes <- NCI_TPW_gep_treated - NCI_TPW_gep_untreated
fold_changes <- as.data.frame(fold_changes)
```

**Renaming of cellline SK-MEL-2**  
One problem, which occured at the first structuring of the data by using the grep() function was that the cellline name SK-MEL-2 is part of cellline SK-MEL_28. To solve this we renamed that cellline to SK-MEL-2_.  

```{r }
#SK-MEL-2_ is added as new factor 
levels(cellline_annotation$Cell_Line_Name) <- c(levels(cellline_annotation$Cell_Line_Name), 
                                                "SK-MEL-2_")
cellline_annotation[33, 1] <- "SK-MEL-2_"
#delete level SK-MEL-2 (otherwise we would have 62, instead of 61 levels)
cellline_annotation$Cell_Line_Name <- factor(as.character(
  cellline_annotation$Cell_Line_Name))
```

**Renaming of cancertype Non-Small Cell Lung
To make the legend of the following plots smaller and clearer, we abbreviate Non-Small Cell Lung with NSCL.
```{r}
#NSCL is added as new factor 
levels(cellline_annotation$Cancer_type) <- c(levels(cellline_annotation$Cancer_type), 
                                                "NSCL")
cellline_annotation[grep ("Non-Small Cell Lung", cellline_annotation$Cancer_type), "Cancer_type"] <- "NSCL"
#delete level Non-Small Cell Lung (otherwise we would have 16, instead of 15 levels)
cellline_annotation$Cancer_type <- factor(as.character(
  cellline_annotation$Cancer_type))
```

**Annotation** of all sample names  
A matrix is created, which contains for each sample name the drug, cellline and cancertype. This matrix is later used for labeling and coloring of our plots.     

1. Drug
```{r }
sample_drug <- as.data.frame(sapply(levels(drug_annotation$Drug), grepl, 
                                    colnames(fold_changes), ignore.case = TRUE))
  #creates table with TRUE and FALSE for each sample and drug
rownames(sample_drug) <- colnames(fold_changes)
drugs <- as.vector(apply(sample_drug, 1, function(x){
  colnames(sample_drug[which(x)])
}))
```

2. Cellline
```{r }
sample_cellline <- as.data.frame(sapply(levels(cellline_annotation$Cell_Line_Name), grepl, 
                                        colnames(fold_changes), ignore.case = TRUE)) 
  #creates table with TRUE and FALSE for each sample and cellline
rownames(sample_cellline) <- colnames(fold_changes)
cellline <- as.vector(unlist(apply(sample_cellline, 1, function(x){
  colnames(sample_cellline[which(x)])
})))

annotation <- cbind("Drug" = drugs, "Cellline" = cellline)
rownames(annotation) <- colnames(fold_changes)
```

3. Cancertype
```{r }
cancertype <- sapply(annotation[, 2], function(x){ 
  #2nd column contains cellline annotation of samples
  cellline_annotation$Cancer_type[cellline_annotation$Cell_Line_Name == x]
})
cancertype <- as.vector(unlist(cancertype))


annotation <- cbind(annotation, "Cancertype" = cancertype)
rm(drugs, sample_drug, cellline, sample_cellline, cancertype)
```

**Preparation for Coloring**   
Create a vector which assigns each drug or each cancertype a color. These color vectors were used for coloring of the plots and creating the corresponding legends. For this purpose we searched for a color palette containing 15 colors, which are easy to distinguish. However, we only found some like RColorBrewer, which had no palette containing at least 15 distinguishable colors. Therefore we just defined our own color_palette by using the names of easily distinguishable colors. 

1. Coloring according to drug (color_vector_all_drugs)
```{r }
#define a color palette with 15 chosen colors
color_palette_drug <- c("aquamarine", "brown", "forestgreen", "slategrey", 
                        "chartreuse", "darkgoldenrod1", "cadetblue","purple", 
                        "firebrick1", "deepskyblue", "gold", "violetred4", 
                        "deeppink", "plum2", "blue" )
names(color_palette_drug) <- levels(drug_annotation$Drug)
  
#create vector containing a color name for each sample according to drug
color_vector_drug <- sapply(rownames(annotation), function(x){
  unname(color_palette_drug[annotation[x, 1]]) #first column of annotation contains drug
})
```

2. Coloring according to cancertype (color_vector_cancertype)
```{r }
#define a color palette with 9 chosen colors
color_palette_cancertype <- c("aquamarine", "brown", "forestgreen", "chartreuse", 
                              "darkgoldenrod1", "cadetblue","purple", 
                              "firebrick1", "deepskyblue")

names(color_palette_cancertype) <- levels(cellline_annotation$Cancer_type)

#create vector containing a color name for each sample according to cancertype
color_vector_cancertype <- sapply(rownames(annotation), function(x){
  unname(color_palette_cancertype[annotation[x, 3]]) #3rd columns of annotation contains cancertype 
})
```

### Density plot 
To show the distribution of all gene expression values, a density plot was drawn. The black line contains all values measured for control samples (untreated). In red the distribution of the gene expressiion of all samples treated with 15 drugs is shown.
```{r }
plot(density(NCI_TPW_gep_untreated), "Density plot of gene expression", cex.main = 1.2)
lines(density(NCI_TPW_gep_treated), col = "red")
legend("topright", legend = c("untreated", "treated"), col = c("black", "red"), pch = 15)
```

As expected, there can be hardly seen any difference between both curves. One reason for that is that the gene expression of most of the 13299 genes did not change due to the drug. 

### Boxplot
In a next step the gene expression profile of each untreated sample was visualized in a boxplot to look, whether the complete expression profiles look the same over all samples or whether normalization is needed. 
```{r warning = FALSE }
#xaxt = "n": removes labels on x-axis
#title() used to move xlab nearer to the axis
par(mar = c(4, 4, 4, 7.5), xpd = "TRUE")
boxplot(NCI_TPW_gep_untreated, 
        xaxt = "n", 
        ylab = "Gene expression profile", 
        vertical =  T, 
        cex.main = 1.12,
        main = "Gene expression profile of untreated NCI60 celllines")
title(xlab = "Samples", line = 1.0)
```

In the boxplot sudden differences occuring with a regular pattern can be observed. An explanation for that could be that the gene expression of the samples was measured at different points of time or at different laboratories. This raised the question, whether these batches match with the 15 drugs these control measurements of untreated expressions were made. Therefor, the boxes were colored according to the drug the control was used for.   

**Color plot according to drugs**
```{r warning = FALSE}
par(mar = c(4, 4, 4, 7.5), xpd = "TRUE")
boxplot(NCI_TPW_gep_untreated, 
        xaxt = "n", 
        ylab = "Gene expression profile", 
        vertical =  T, 
        main = "Gene expression profile of untreated NCI60 celllines", 
        cex.main = 1.12,
        boxcol = color_vector_drug)
title(xlab = "Samples", line = 1.0)
legend("topright", 
       legend = names(color_palette_drug), 
       col = color_palette_drug,
       inset = c(-0.35, 0),
       pch = 19)
```

Since the batches exactly match the different drugs for which the untreated expression was determined, a **normalization** is necessary if the values over the various drugs should be comparable. 
```{r warning = FALSE}
#each sample should have mean 0 and sd 1
untreated_normalized <- apply(NCI_TPW_gep_untreated, 2, function(x){
  (x - mean(x)) / sd(x)
})
FC_normalized <- apply(fold_changes, 2, function(x){
  (x - mean(x)) / sd(x)
})

#boxplot of normalized untreated values
par(mar = c(4, 4, 4, 7.5), xpd = "TRUE")
boxplot(untreated_normalized, 
        xaxt = "n", 
        ylab = "Gene expression profile", 
        vertical =  T, 
        main = "Normalized gene expression profile of untreated NCI60 celllines",
        cex.main = 1.12, 
        boxcol = color_vector_drug)
title(xlab = "Samples", line = 1.0)
legend("topright",
       legend = names(color_palette_drug), 
       col = color_palette_drug, 
       pch = 19,
       inset = c(-0.35, 0))
```

### PCA
A principal component analysis is used for dimensionality reduction. With these technique it is possible to depict most of the variance observed in the gene expression changes due to drug treatment (foldchange) over all samples. The points were colored firstly according to drug and secondly according to cancertype to see whether there are clusters corresponding to drug treatment or cancertype. 

**Coloring according to drug**
```{r warning = FALSE, fig.height=8}
pca <- prcomp(FC_normalized)

par(mar = c(4, 4, 4, 7.5), mfrow = c(2, 1))

#PC1 and PC2
plot(pca$rotation[,1], 
     pca$rotation[,2], 
     col = color_vector_drug, 
     pch = 19, 
     xlab = "PC1", 
     ylab = "PC2")
#create legend on the right side
legend("topright", 
       legend = names(color_palette_drug), 
       col = color_palette_drug, 
       pch = 19, 
       xpd = "TRUE",
       inset = c(-0.35, 0))
#Title: mtext = margin text, side = 3 (upside)
mtext("PCA of FC colored according to drug", 
      side = 3, 
      line = -2.5,
      cex = 1.12,
      font = 2, #bold
      outer = TRUE)

#PC2 and PC3
plot(pca$rotation[,1], 
     pca$rotation[,3], 
     col = color_vector_drug, 
     pch = 19, 
     xlab = "PC1", 
     ylab = "PC3")

```

In the PCA plot it can be seen that the celllines treated with the same drug accumulate in certain areas. 

**Coloring according to cancertype**
```{r warning = FALSE, fig.height=8}
par(mar = c(4, 4, 4, 7), mfrow = c(2, 1))
#PC1 and PC2
plot(pca$rotation[,1], 
     pca$rotation[,2], 
     col = color_vector_cancertype, 
     pch = 19, 
     xlab = "PC1", 
     ylab = "PC2")
legend("topright",
       legend = names(color_palette_cancertype), 
       col = color_palette_cancertype, 
       pch = 19, 
       xpd = "TRUE",
       inset = c(-0.28, 0))
#PC2 and PC3
plot(pca$rotation[,2], 
     pca$rotation[,3], 
     col = color_vector_cancertype, 
     pch = 19, 
     xlab = "PC2", 
     ylab = "PC3")

mtext("PCA of FC colored according to cancertype", 
      side = 3, 
      line = -2.5,
      cex = 1.12,
      font = 2, #bold
      outer = TRUE)

rm(pca)
```

The colors showing which cancertype a cellline belongs to seem rather random distributed in the PCA plot. No clustering between the celllines beeing part of the same cancertype can be observed. 

### Most regulated genes
**Barplot** to find genes, which were mostly regulated by all cancer treatments 
```{r}
#calculating the mean FC over positive FC values
mean_FC_abs <- apply(abs(fold_changes), 1, mean)
mean_FC_abs <- sort(mean_FC_abs, decreasing = TRUE)
par(oma = c(10, 1, 1, 1))
barplot(mean_FC_abs[1:20], 
        main = "Genes with highest mean in absolute FC",
        cex.main = 1.12,
        ylab = "mean FC", 
        las = 2)
```

**Boxplot** of genes with highest mean FC
```{r}
#FC_samples_with_highest_mean_FC contains the gene expression of the 20 biomarkers (20 columns) of all samples(819 rows) 
FC_samples_with_highest_mean_FC <- data.matrix(as.data.frame(sapply(names(mean_FC_abs)[1:20], function(x){
  fold_changes[which(x == rownames(fold_changes)),]
})))
boxplot(FC_samples_with_highest_mean_FC, 
      ylab = "foldchange", 
      main = "Boxplot of foldchange of the genes with highest mean FC", 
      cex.main = 1.12,
      las=2) 
```





##**Specific analysis: Erlotinib **

## 2. Milestone: find most affected cell lines and genes

### Data preparation 
**Erlotinib treated** cell lines are selected and the matrix of the foldchange is normalized

```{r }
#new matrix only with samples/columns treated with erlotinib  (e=erlotinib)
e_treated <- NCI_TPW_gep_treated[,grep ("erlotinib", colnames(NCI_TPW_gep_treated))]
e_untreated <- NCI_TPW_gep_untreated[,grep ("erlotinib", colnames(NCI_TPW_gep_treated))]

#z-Transformation of e_treated/e_untreated to get mean=0 and sd=1, equivalent to scale(e_treated, scale=TRUE)
e_treated <- apply(e_treated, 2, function(x){
  (x - mean(x)) / sd(x)
})
e_untreated <- apply(e_untreated, 2, function(x){
  (x - mean(x)) / sd(x)
})

# calculate foldchange by subtracting e_untreated_norm from e_treated_norm
e_foldchange <- e_treated - e_untreated

#colnames of e_foldchange with cellline instead of complete sample name
cellline <- sapply(colnames(e_foldchange), function(x){
  annotation[x,"Cellline"]
  }) 
colnames(e_foldchange) <- cellline

```

### **Most regulated cell lines**
### Table of 15 cell lines   
Cell lines, which showed the highest variance over all genes were selected

```{r comment=NA}
#select 15 cell lines with highest variance (greater than 75% quantile, sorted by decreasing value)
var_cell_line <- apply(e_foldchange, 2, var)
cell_line_var_greater_75quantile <- sort(var_cell_line [which (abs(var_cell_line) > quantile(abs(var_cell_line), 0.75))], decreasing = TRUE)
cell_line_var_greater_75quantile <- round(cell_line_var_greater_75quantile, digits=5)

#add column with cell line for top15 celllines
celllines_top15 <- as.data.frame(names(cell_line_var_greater_75quantile))

#add column with cancertype for top15 celllines
annotation_cancertype <- annotation[,"Cancertype"]
names(annotation_cancertype) <- colnames(e_foldchange)
cancertypes_top15 <- sapply(names(cell_line_var_greater_75quantile), function(x) {annotation_cancertype[which(x == names(annotation_cancertype))]
})
table_cell_lines_var_top15 <- cbind(celllines_top15, cell_line_var_greater_75quantile, cancertypes_top15)

colnames(table_cell_lines_var_top15) <- c("Cellline", "Variance", "Cancertype")
rownames(table_cell_lines_var_top15) <- c(1:nrow(celllines_top15))
print(table_cell_lines_var_top15)
```

### PCA
PCA is performed to find cell lines, which differ most from the other cell lines
```{r message=FALSE, warning=FALSE}
#PCA with transformed matrix (each point represents a sample):
par(mar= c(4, 4, 4, 7))
pca <- prcomp(e_foldchange)
plot(pca$rotation[,1], 
     pca$rotation[,2], 
     col=color_vector_cancertype, 
     pch=19, 
     xlab = "PC1", 
     ylab="PC2", 
     main = "PCA of cell lines",
     cex.main = 1.12)
legend("topright", 
       legend = names(color_palette_cancertype), 
       col = color_palette_cancertype, 
       pch = 19, 
       xpd = TRUE, 
       inset = c(-0.28, 0))
#label points
text(pca$rotation[ ,1], 
     pca$rotation[ ,2], 
     colnames(e_foldchange),
     pos = 3,
     cex = 0.6)
```

### **Most regulated genes**
### Volcano plot
Create volcano plot to find the genes with the highest fold change and highest significance

```{r warning=FALSE, message=FALSE}
#mean of gene expression of each gene over all cell lines
e_foldchange_mean_over_cell_lines <- rowMeans(e_foldchange) #equal to e_treated_mean_over_cell_lines - e_untreated_mean_over_cell_line

#determine the p-value for a paired two-sample t-test 
p_values <- sapply(rownames(e_treated), function(x) {
  t.test(e_treated[x,], e_untreated[x,],paired= T)$p.value}) # perform t-test and save p-values of each gene in p_vales-vector
FDR_values <- p.adjust(p_values, method = "BH", n = length(p_values))#calculate FDR with benjamini-hochberg (BH)


#table of results 
statistics_values <- cbind(e_foldchange_mean_over_cell_lines, FDR_values)
#coloring with package enhanced volcano
#install package EnhancedVolcano (needs ggplot2, ggrepel)
library(ggplot2)
library(ggrepel)
library(EnhancedVolcano)

EnhancedVolcano(statistics_values, 
                lab = rownames(statistics_values),
                x = "e_foldchange_mean_over_cell_lines", 
                #colname of FC values in this table (statistics_values)
                y = "FDR_values", #colname of FDR (statistics_values)
                title = "Volcano plot of all genes",
                titleLabSize = 13,
                pCutoff = 10e-15, #threshold for coloring significant ones
                FCcutoff = 1, #threshold for coloring high FC
                transcriptPointSize = 2,
                transcriptLabSize = 3,
                legendPosition = "right",
                legendLabSize= 10,
                axisLabSize = 10) # remove subtitle and caption generated by Bioconductor

```


### Density plot 
Draw a density plot only with biomarkers identified by volcano plot
```{r}
#save the "red" genes seen in the volcano plot in a vector for further analysis
biomarkers <- rownames(statistics_values)[which(abs(statistics_values[, 1]) > 1 
                                                   & statistics_values[, 2] < 10e-15)]

#Density plot with these genes (untreated vs. treated)
plot(density(e_treated[biomarkers, ]), "Density plot of gene expression", cex = 1.2, col = "red")

lines(density(e_untreated[biomarkers, ]), col = "black")
legend("topright", legend = c("untreated", "treated"), col = c("black", "red"), pch = 15)

```

### MA-Plot 
Draw an MA plot to compare the fold change to the mean expression of all genes
```{r}
#install package and load ggplot2 and ggrepel
library(ggplot2)
library(ggrepel)

#create matrices with the variables M and A of a MA-plot
M <- e_foldchange # M= log2(treated) - log2 (untreated)
A <- 1/2*(e_treated+ e_untreated) # average log2-expression value A = 1/2 (log2(treated)+log2(untreated))
MA <- cbind("M"= rowMeans(M), "A" = rowMeans(A), FDR_values)
rm(M, A)
MA <- as.data.frame(MA)
MA$Significant <- ifelse(MA$FDR_values<0.05, "FDR < 0.05", "Not Sig")

#matrix with important genes of MA plot 
MA_labeled <- MA[which(MA[ , "M"] > 1.5 | MA[,"M"] > 0.95 & MA[,"A"] > 10) , ]

#MA plot labeled with important genes of MA plot
ggplot(data=MA)+ 
  aes(x=A, y=M, color= Significant)+
  geom_point()+
  xlab("mean expression")+
  ylab("log fold change")+
  ggtitle("MA plot of all genes")+
  geom_text(data=MA_labeled, aes(A, M, label=rownames(MA_labeled)))+
  theme(plot.title = element_text(size=13, face="bold", hjust=0.5)) # change the size and face (bold) of the title and centre it (hjust=0.5)


```

### Venn Diagram
Venn Diagramm is drawn to compare the most regulated genes by volcano plot and MA plot
```{r warning=FALSE, message=FALSE}
#Venn Diagram with biomarkers of volcano plot and MA plot
library(VennDiagram)
par(oma = c(2, 2, 2, 2))
biomarkers_MA_vector <- rownames(MA_labeled)
venn.plot <- venn.diagram(
  x = list(
    "Volcano Plot" = biomarkers,
    "MA Plot" = biomarkers_MA_vector
    ),
  filename = NULL, 
  fill = c("blue", "red"), 
  main = "Venn Diagramm of most regulated genes", 
  main.fontface = 2,
  main.cex = 1.12,
  main.fontfamily = "sans", # font type of title is Arial 
  cat.fontfamily = "sans",
  cat.cex = 0.9,
  cat.dist = 0.1, # distance between category and edge of circle
  fontfamily = "sans"
  );
grid.draw(venn.plot);
```

### Boxplot 
Draw a boxplot of the **foldchange** of biomarkers
```{r}
# create a matrix foldchange_biomarkers, with the foldchange only of the biomarkers
foldchange_biomarkers <- sapply(biomarkers, function(x){
  e_foldchange[x, ]
})
boxplot(foldchange_biomarkers, ylab= "foldchange", 
        main= "Boxplot of foldchange of the biomarkers", cex = 1.12, las=2)
```

Draw a boxplot of the **untreated vs. treated gene expression** of biomarkers 
```{r}
# create a matrix e_treated_biomarkers/ e_untreated_biomarkers, with the gene expression only of the biomarkers
e_treated_biomarkers <- sapply(biomarkers, function(x){
  e_treated[x, ]
})
e_untreated_biomarkers <- sapply(biomarkers, function(x){
  e_untreated[x, ]
}) 
colnames(e_treated_biomarkers) <- paste(colnames(e_treated_biomarkers),"Treated",
                                          sep = "_") #add treated to colnames

# create a matrix, which contains gene expression of untreated and treated and sort it after colnames
e_treated_untreated_biomarkers <- cbind (e_treated_biomarkers, e_untreated_biomarkers)
e_treated_untreated_biomarkers <- e_treated_untreated_biomarkers[,order(colnames(e_treated_untreated_biomarkers))]

# create a color vector, where untreated samples are green and treated ones are red
color_boxplot_e_treated_untreated <- sapply(colnames(e_treated_untreated_biomarkers), function(x) {
  ifelse(x %in% grep ("Treated",colnames(e_treated_untreated_biomarkers), value = TRUE),
         "red", "green")})

# boxplot, where treated and untreated are right next to each other 
boxplot(e_treated_untreated_biomarkers, ylab= "gene expression (log2)", 
        main= "Boxplot of gene expression of the biomarkers", cex = 1.12, las=2, col= color_boxplot_e_treated_untreated)
```

## 3. Milestone - Does the fold change of specific genes correlate with cell growth inhibition?
### Data prepatation 

```{r}
# vector which only includes celllines which were used in e_foldchange_normalized
NegLogGI50_59_celllines <- NegLogGI50 ["erlotinib", -c(8,29)]
LogGI50_59_celllines <- NegLogGI50_59_celllines * (-1)


#colnames of e_untreated with cellline instead of complete sample name
colnames(e_untreated) <- cellline
```

### Scatter plot: Relation between GI50 and EGR1 expression
Draw a scatterplot which include the GI50 values against the EGR1 expression revative to the untreated control. EGR1 is a transcriptional factor and is assocciated with the activiation of tumor suppressor genes like p53/TP53 and TGFB1, and plays an important role in the regulation of growth factor responses.
 
```{r figEGR1 , fig.width = 6, fig.hight =6, fig.asp = 1.1, warning=FALSE}
#Coloring according to cancertype
e_color_cancertype <- color_vector_cancertype[grep("erlotinib", names(color_vector_cancertype), value = TRUE)]

#Scatter plot
par(mar= c(4, 4, 4, 7), xpd = "TRUE") #size of outer margins: bottom, top, left, right
plot(LogGI50_59_celllines, e_foldchange ["EGR1",], 
     col = e_color_cancertype, 
     pch = 19, 
     xlab = "logGI50", 
     ylab = "EGR1 Expression (log2, relative to control)",        
     main = "Erlotinib 24h", 
     cex.main = 1.12, 
     col.main = "deepskyblue")

segments(-7.11,0, -3.88)
legend("topright", 
       legend = names(color_palette_cancertype), 
       col = color_palette_cancertype, 
       inset = c(-0.32, 0),
       pch = 19)


#label only points in the left bottom quarter
labeled_celllines <- names(LogGI50_59_celllines)[LogGI50_59_celllines < - 5.5
                                                        & e_foldchange["EGR1", ] < 0]

text(LogGI50_59_celllines[labeled_celllines], e_foldchange ["EGR1", labeled_celllines], 
     labels = labeled_celllines,
     cex = 0.7,
     pos = 3)#position of text at the top of the point

mtext(side=3, line=-1, text="r= 0.6792 (***)", adj=c(0.01))
```

###linear regression  between EGR1 expression and the GI50 value after erlotinib treatment
```{r comment = NA}
linearMod_EGR1 <- lm(LogGI50_59_celllines ~ e_foldchange ["EGR1",])  # build linear regression model on full data

summary(linearMod_EGR1)
```
 Only 25 % can be described by EGR1- expression, which makes a linear regression model kind of unfitted. 

   
### Her 1 gene expression in the untreated celllines against GI50 values     

```{r warning = FALSE}
par(mar = c(4, 4, 4, 7), xpd = "TRUE")
plot(LogGI50_59_celllines, e_untreated ["EGFR",], 
      col = e_color_cancertype, 
      pch = 19, 
     xlab = "logGI50", 
     ylab = "EGFR Expression (untreated)",        
     main = "Expression of the epidermal growth factor receptor (Her 1)",
     cex.main = 1.12)
legend("topright", 
    legend = names(color_palette_cancertype), 
    col = color_palette_cancertype, 
    pch = 19,
    inset = c(-0.28, 0),
    xpd = TRUE)

text(LogGI50_59_celllines, e_untreated ["EGFR",], 
     labels  = names(LogGI50_59_celllines),
     cex = 0.7, 
     pos = 3)

labeled_celllines_EGFR <- names(LogGI50_59_celllines)[LogGI50_59_celllines < - 5.5
                                                        & e_untreated ["EGFR", ] > 8]

text(LogGI50_59_celllines[labeled_celllines_EGFR], e_untreated ["EGFR", labeled_celllines_EGFR], 
     labels = labeled_celllines_EGFR,
     cex = 0.7,
     pos = 3)
#Funktioniert noch nicht
abline(lm(LogGI50_59_celllines ~ e_untreated["EGFR",]))


```


### lineare regression Her 1 expression against the GI50 values

```{r comment = NA}
linearMod_Her1 <- lm(LogGI50_59_celllines ~ e_untreated ["EGFR",])  # build linear regression model on full data
summary(linearMod_Her1)
```
mode does not fit that well, only 17% can be disrecped by Her1 expression.
Maybe we have to consider all types of Her receptors 1-4!!! 
cause the composition of Her1 and Her3/4 play a part when it comes to bad/good prognoses an therfore could 
play a role in the GI50 values an the success of erlotinib treatment.

## 4. Milestone: Which pathways are affected?

The aim of our last milestone was to identify the pathways which are most regulated due to erlotinib. We used two methods to create a heatmap of the pathways. In the first one Supplementary Table S2 from the NCI TPW was used. In this table 5-15 genes are listed for each of the pathways. The second method was to use the R package progeny, which scores 100 genes per pathway to calculate the pathway activity and should explain better the pathway activity since more data is regarded. 

### 1. Pathways according Supplementary Table S2
First the genes listed for each pathway were stored in one vector. These pathway vectors were than combined in one table called pathways. 
```{r}
#assign genes to pathways (as in supplementary material)
MAPK <- c("AURKA", "AURKB", "SON", "CENPA", "KIF11", "DUSP6", "TPX2", "EGR1")
AKT_PI3K <- c("CFLAR", "XIAP", "BIRC5", "BIRC3", "GADD45A", "MCL1", "BCL2", 
              "BCL2L1", "HIF1A", "AR", "STAT3", "IL6", "JUN", "FOS")
  #AP1 for AKT_PI3K excluded (genename does not exist in FC)
  #do they mean with AP1 these 5 genes? AP1AR, AP1B1, AP1G1, AP1G2, AP1M2, AP1S1, AP1S2
  #same problem for VEGF --> VEGFA, VEGFB, VEGFB
Cell_Cycle_Checkpoint <- c("CHEK1", "CHEK2", "TP53", "MDM2", "CDKN1A", "CCNE1", "CDK2", 
                           "CDC25A", "SMC1A", "CCNB1", "CDK1", "CDC25B", "CDC25C", 
                           "PLK1", "WEE1", "CCND1")
JAK_STAT <- c("SOCS1", "NMI", "BCL2L1", "CDKN1A", "MYC")
Immunity_Related <- c("BCL2L1", "XIAP", "BIRC5", "CFLAR", "IL6", "IL1B", "TNF")
  #PTGS does not exist
DNA_repair <- c("XRCC6", "PRKDC", "DCLRE1C", "XRCC4", "LIG4", "BRCA1", 
                "RAD52", "BRCA2", "RAD54L", "ATM", "ATR", "PARP1")
  #NHEJ1 does not exist
DNA_damage <- c("TP53", "FAS", "BAX", "PMAIP1")
  #BBC3 & ARG do not exist
ER_Stress_Survival <- c("HSPA5", "HSP90B1", "XBP1", "P4HB", "ATF4", "GADD45A")
ER_Stress_Apoptotic_Response <- c("ATF3", "DDIT3", "TNFRSF10B", "TRIB3", "BCL2L11", "CASP2")
  #BBC3 & GADD34 do not exist
Apoptosis_extrinsic_activation <- c("BID", "FAS", "CASP8", "CASP9", "APAF1")
Apoptosis_intrinsic_activation <- c("BAX", "BAK1", "BID", "PMAIP1", 
                                    "CASP6", "CASP9", "APAF1")
  #BBC3 does not exist
Autophagy_recycling_starvation <- c("MAP1LC3B", "ULK1", "ATG13", "BECN1", 
                                    "SQSTM1", "ATG5", "ATG12", "CTSB")
Autophagy_toxic <- c("SQSTM1", "ATG7", "RIPK1", "CTSB")

#create named list of all pathways
pathways <- list(MAPK = MAPK, 
                 AKT_PI3K = AKT_PI3K, 
                 Cell_Cycle_Checkpoint = Cell_Cycle_Checkpoint, 
                 JAK_STAT = JAK_STAT,
                 Immunity_Related = Immunity_Related,
                 DNA_repair = DNA_repair,
                 DNA_damage = DNA_damage,
                 ER_Stress_Survival = ER_Stress_Survival,
                 ER_Stress_Apoptotic_Response = ER_Stress_Apoptotic_Response,
                 Apoptosis_extrinsic_activation = Apoptosis_extrinsic_activation, 
                 Apoptosis_intrinsic_activation = Apoptosis_intrinsic_activation, 
                 Autophagy_recycling_starvation = Autophagy_recycling_starvation,
                 Autophagy_toxic = Autophagy_toxic) 
rm(MAPK, AKT_PI3K, Cell_Cycle_Checkpoint, JAK_STAT, Immunity_Related, DNA_repair, 
   DNA_damage, ER_Stress_Survival, ER_Stress_Apoptotic_Response, 
   Apoptosis_extrinsic_activation, Apoptosis_intrinsic_activation, 
   Autophagy_recycling_starvation, Autophagy_toxic)
```

This pathway table was then used to create the heatmap_data table, in which the mean expression over all genes assigned to a pathway is calculated for each cellline.
```{r}
#calculate mean FC over genes of one pathway for each sample
heatmap_data <- sapply(1:length(pathways), function(x){ #for each pathway
  sapply(1:ncol(e_foldchange), function(y){ #for each sample
    #calculate mean FC of genes of one pathway
    mean(e_foldchange[pathways[[x]], y]) 
  })
})

colnames(heatmap_data) <- c(names(pathways))
rownames(heatmap_data) <- colnames(e_foldchange)
```

Proof how many clusters are needed with an elbow plot
```{r,  fig.height = 3}
#Elbow plot
library(factoextra)
fviz_nbclust(heatmap_data, 
             FUN = hcut, 
             method = "wss") + #within cluster sums of squares
  labs(title = "Elbow plot: optimal number of cellline clusters")

fviz_nbclust(t(heatmap_data), 
             FUN = hcut, 
             method = "wss") +
  labs(title = "Elbow plot: optimal number of pathway clusters")
```

Colored annotation bars above the heatmap should depict several clusters. Therefore, the dendrogramm was used to first cluster the celllines and afterwards the pathways. 
1. Clustering according to cellline: 
```{r warning = FALSE}
#Clustering with package dendextend
library(dendextend)
#hierachical clustering (hclust) of celllines
#dist(): euclidean distance
#agglomeration method: "ward.D2"
cellline_clustering <- hclust(dist(heatmap_data), method = "ward.D2") 
#cutree: cuts the tree to generate k clusters
cellline_groups <- cutree(tree = as.dendrogram(cellline_clustering), k = 3)

#Create data frame with cancertype for each cellline treated with erlotinib
cellline_cancertype <- as.data.frame(sapply(names(cellline_groups), function(x){ 
  unname(cellline_annotation[which(cellline_annotation$Cell_Line_Name == x), 2])
}))

#save clustering according to dendrogramm and cancertype 
#in a new data frame called cellline_clusters
cellline_clusters <- as.data.frame(cbind(cellline_groups, cellline_cancertype))
colnames(cellline_clusters) <- c("Cellline cluster", "Cancertype cluster")
```

2. Clustering according to pathways:
```{r}
#cluster pathways: 
pathway_clustering <- hclust(dist(t(heatmap_data)), method = "ward.D2") 
pathway_groups <- as.data.frame(cutree(tree = as.dendrogram(pathway_clustering), k = 3))
colnames(pathway_groups) <- "Pathway cluster"
```

Create a heatmap with the package pheatmap (pretty heatmap):
```{r, fig.height = 5, warning = FALSE}
library(pheatmap)
#generate heatmap with colored bars according to clusters
pheatmap(t(heatmap_data),
         clustering_method = "ward.D2",
         annotation_col = cellline_clusters,
         annotation_row = pathway_groups,
         cutree_rows = 3, #makes white spaces between clusters
         cutree_cols = 3,
         main = "Affected pathways by erlotinib",
         mainsize = 1.12,
         show_colnames = FALSE,
         cellwidth = 2,
         cellheight = 15, 
         fontsize = 7,
         fontsize_row = 10)
```

### 2. Heatmap with PROGENy

Using PROGENY, which scores the 100 most important genes for each pathway to depict its activity.
```{r warning = FALSE}
library(progeny)
progeny_heatmap <- progeny(e_foldchange)
```

Proof how many clusters are needed with an elbow plot
```{r, fig.height = 3, warning = FALSE}
#Elbow plot
library(factoextra)
fviz_nbclust(progeny_heatmap, 
             FUN = hcut, 
             method = "wss") + #within cluster sums of squares
  labs(title = "Elbow plot: optimal number of cellline clusters")

fviz_nbclust(t(progeny_heatmap), 
             FUN = hcut, 
             method = "wss") +
  labs(title = "Elbow plot: optimal number of pathway clusters")
```


Clustering according to cellline and pathway
```{r}
#cluster celllines:
cellline_clustering <- hclust(dist(progeny_heatmap), method = "ward.D2")
cellline_groups <- as.data.frame(cutree(tree = as.dendrogram(cellline_clustering), k = 2))
cellline_clusters <- as.data.frame(cbind(cellline_groups, cellline_cancertype))
colnames(cellline_clusters) <- c("Cellline cluster", "Cancertype cluster")
#cluster pathways:
pathway_clustering <- hclust(dist(t(progeny_heatmap)), method = "ward.D2") 
pathway_groups <- as.data.frame(cutree(tree = as.dendrogram(pathway_clustering), k = 2))
colnames(pathway_groups) <- "Pathway cluster"
```

Create heatmap
```{r, fig.height = 6}
pheatmap(t(progeny_heatmap),
         clustering_method = "ward.D2",
         annotation_col = cellline_clusters,
         annotation_row = pathway_groups,
         cutree_rows = 2,
         cutree_cols = 2,
         main = "Affected pathways by erlotinib (PROGENy)",
         mainsize = 1.12, 
         show_colnames = FALSE,
         cellwidth = 2.5,
         cellheight = 15, 
         fontsize = 10,
         fontsize_row = 14)
```

