---
title: "Data analysis: Project 2 Group 4"
output:
  html_document:
    df_print: paged
  pdf_document: default
---
# Molecular Biotechnology, 4th term, Summer 2019
### Anna, Ann-Sophie und Jana

### Table of content
[1. Milestone: Broad analysis](#anchor)  
- [Density plot](#1b)  
- [Boxplot](#1c)  
- [PCA](#1d)  
- [Most regulated genes](#1e)  
[2. Milestone: find most affected cell lines]  
[3. Milestone: find biomarkers]  
[4. Milestone - Does the fold change of specific genes correlate with cell growth   inhibition?]
[5. Milestone - final results]

```{r, include=FALSE}
#Load required packages
library(knitr)
```

```{r setup, include=FALSE} 
#code and output not included in final file
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache = TRUE)
knitr::opts_chunk$set(fig.width = 9, fig.height = 6, fig.align = "center")
```

First of all, a broad analysis containing all samples of the NCI60 panel with 15 different cancer drugs was performed. In the specific analysis we focused on the drug erlotinib, which is an inhibitor of EGFR. Three milestones were defined to analyse which pathways are mostly regulated due to the drug treatment. The first one included finding the celllines which have the strongest fold change and the most regulated genes (biomarkers). Secondly, the correlation between the drug sensitivity of the various celllines (GI50) and the EGR1 expression was analysed. In the last part, we analysed the effect of erlotinib on different pathways using the package PROGENY and illustrating the fold change in gene expression due to the drug in a heatmap. 

### Load data
Firstly, the data generated from the NCI60 cellline panel is downloaded and the various tables are saved as data frames. 

```{r }
NCI_TPW_gep_treated <- readRDS(url("https://ndownloader.figshare.com/files/14720180?private_link=db1411debcfbe2618d2f"))
NCI_TPW_gep_untreated <- readRDS(url("https://ndownloader.figshare.com/files/14720183?private_link=db1411debcfbe2618d2f"))
NCI_TPW_metadata <- read.delim("https://ndownloader.figshare.com/files/14720186?private_link=db1411debcfbe2618d2f")
NegLogGI50 <- readRDS(url("https://ndownloader.figshare.com/files/ 14720210?private_link=074e0120fe5e682f3d14"))
CCLE_basalexpression <- readRDS(url("https://ndownloader.figshare.com/files/14770127?private_link=fc0c71246dc192982a3c"))
CCLE_copynumber <- readRDS(url("https://ndownloader.figshare.com/files/14770130?private_link=fc0c71246dc192982a3c"))
CCLE_mutations <- readRDS(url("https://ndownloader.figshare.com/files/14770133?private_link=fc0c71246dc192982a3c"))
cellline_annotation <-read.delim("https://ndownloader.figshare.com/files/14768981?private_link=efb6a529eaf2d4dc6432")
drug_annotation <- read.delim("https://ndownloader.figshare.com/files/14768984?private_link=efb6a529eaf2d4dc6432")
```

## 1. Milestone: Broad analysis{#anchor}

The first part of our project was a broad analysis to get an overview of the data generated in the NCI Transcriptional Pharnacodynamics Workbench (TPW). The distribution of the data was analyzed with a density plot, as well as with a Boxplot to show whether the data is already normalized or normalization is needed for further analysis. The data of the TPW contains gene expression values for 819 samples and 13299 genes. For each of the cancer celllines the normal gene expression, as well as the gene expression after drug treatment with one of 15 drugs was measured. In a principal component analysis it was tested, whether there are clusters of samples corresponding to the same cancertype or samples treated with the same drug by coloring according to these two attributes. In the last step of the overall analysis we looked which genes were mostly regulated through the therapeutic cancer treatment.  

### Data preparation and annotation

After loading the data of the TPW, we need some preparation and annotation of the data to perform our analysis. To show the effect of a drug on the gene expression the log2 fold change, which is a measurement for the quantitative change due to drug treatment, was used. Since the gene expression values are already logarithmic, the fold change can be calculated by substracting the untreated values (as a control of normal gene expression for each gene in each sample) from the treated ones. 
  
#### Calculate fold change due to drug treatment  

```{r }
fold_changes <- NCI_TPW_gep_treated - NCI_TPW_gep_untreated
fold_changes <- as.data.frame(fold_changes)
```

    
#### Renaming of cellline SK-MEL-2 
One problem, which occured at the first structuring of the data by using the grep() function was that the cellline name SK-MEL-2 is part of cellline SK-MEL_28. To solve this we renamed that cellline to SK-MEL-2_.  

```{r }
#SK-MEL-2_ is added as new factor 
levels(cellline_annotation$Cell_Line_Name) <- c(levels(cellline_annotation$Cell_Line_Name), 
                                                "SK-MEL-2_")
cellline_annotation[33, 1] <- "SK-MEL-2_"
#delete level SK-MEL-2 (otherwise we would have 62, instead of 61 levels)
cellline_annotation$Cell_Line_Name <- factor(as.character(
  cellline_annotation$Cell_Line_Name))
```
  
#### Renaming of cancertype Non-Small Cell Lung 
To make the legend of the following plots smaller and clearer, we abbreviate Non-Small Cell Lung with NSCL.
```{r}
#NSCL is added as new factor 
levels(cellline_annotation$Cancer_type) <- c(levels(cellline_annotation$Cancer_type), 
                                                "NSCL")
cellline_annotation[grep ("Non-Small Cell Lung", cellline_annotation$Cancer_type), "Cancer_type"] <- "NSCL"
#delete level Non-Small Cell Lung (otherwise we would have 16, instead of 15 levels)
cellline_annotation$Cancer_type <- factor(as.character(
  cellline_annotation$Cancer_type))
```
  
#### Annotation of all sample names  
A dataframe (called annotation) is created, which contains for each sample name (in 819 rows) the drug, cellline and cancertype. This annotation is later used for labeling and coloring of our plots.     

**1. Drug**   
For finding the drug a certain sample was treated with the function grepl was used which shows whether a drug listed in the drug_annotation is contained in the sample name (colnames of fold_changes).
```{r }
sample_drug <- as.data.frame(sapply(levels(drug_annotation$Drug), grepl, 
                                    colnames(fold_changes), ignore.case = TRUE))
  #creates table with TRUE and FALSE for each sample (819 rows) and drug (15 columns)
rownames(sample_drug) <- colnames(fold_changes) #sample names as rownames
drugs <- as.vector(apply(sample_drug, 1, function(x){ #for each row of the sample_drug dataframe (=samples)
  #save the drug, which is the columnname in the column of the TRUE
  colnames(sample_drug[which(x)]) 
}))
```

**2. Cellline**  
The cellline was extracted from the sample name in a similar way as the drug. The two vectors with the drug and cellline of each sample were then combined in one data frame.
```{r }
sample_cellline <- as.data.frame(sapply(levels(cellline_annotation$Cell_Line_Name), grepl, 
                                        colnames(fold_changes), ignore.case = TRUE)) 
  #creates table with TRUE and FALSE for each sample (819 rows) and cellline (61 columns)
rownames(sample_cellline) <- colnames(fold_changes) #sample names as rownames
cellline <- as.vector(unlist(apply(sample_cellline, 1, function(x){ 
  #for each row of the sample_drug dataframe (=samples)
  #save the cellline, which is the columnname in the column of the TRUE
  colnames(sample_cellline[which(x)])
})))

#annotation with drugs and celllines in columns for each of the samples (819 rows)
annotation <- cbind("Drug" = drugs, "Cellline" = cellline)
rownames(annotation) <- colnames(fold_changes)
```

**3. Cancertype**
In the cellline_annotation each cellline is assigned to one of seven different cancertypes, which is added as a third column in our annotation. 
```{r }
cancertype <- sapply(annotation[, 2], function(x){ 
  #2nd column of annotation contains cellline name of samples
  #save the cancertype the cellline belongs to 
  #by taking the word in cellline_annotation in column Cancer_type and in the row, where the cellline x stands
  cellline_annotation$Cancer_type[cellline_annotation$Cell_Line_Name == x]
})
cancertype <- as.vector(unlist(cancertype)) #to get a vector instead of a list of the cancertypes per sample

#add cancertype in annotation
annotation <- cbind(annotation, "Cancertype" = cancertype)
#Remove all variables which are no longer needed
rm(drugs, sample_drug, cellline, sample_cellline, cancertype)
```

#### Preparation for Coloring    
For coloring according to drug or cancertype both a color vector was created which assigns each drug or each cancertype a color. These color vectors were used for coloring of the plots and creating the corresponding legends. For this purpose we searched for a color palette containing 15 colors, which are easy to distinguish. However, we only found some like RColorBrewer, which had no palette containing at least 15 distinguishable colors. Therefore we just defined our own color_palette by using the names of easily distinguishable colors. 

**1. Coloring according to drug (color_vector_all_drugs)**
```{r }
#define a color palette with 15 chosen colors
color_palette_drug <- c("aquamarine", "brown", "forestgreen", "slategrey", 
                        "chartreuse", "darkgoldenrod1", "cadetblue","purple", 
                        "firebrick1", "deepskyblue", "gold", "violetred4", 
                        "deeppink", "plum2", "blue" )
#assign each color one of the 15 drugs
names(color_palette_drug) <- levels(drug_annotation$Drug)
  
#create vector containing a color name for each sample according to drug (length 819)
color_vector_drug <- sapply(rownames(annotation), function(x){ #for all samples x
  unname(color_palette_drug[annotation[x, 1]]) #first column of annotation contains drugs
})
```

**2. Coloring according to cancertype (color_vector_cancertype)**
```{r }
#define a color palette with 9 chosen colors
color_palette_cancertype <- c("aquamarine", "brown", "forestgreen", "chartreuse", 
                              "darkgoldenrod1", "cadetblue","purple", 
                              "firebrick1", "deepskyblue")

#each color is assigned the name of the 9 cancertypes
names(color_palette_cancertype) <- levels(cellline_annotation$Cancer_type)

#create vector containing a color name for each sample according to cancertype (length 819)
color_vector_cancertype <- sapply(rownames(annotation), function(x){
  unname(color_palette_cancertype[annotation[x, 3]]) #3rd columns of annotation contains cancertype 
})
```

### Distribution of gene expression values for "untreated" and "treated" {#1b}
To show the distribution of all gene expression values, a **density plot** was drawn. The black line contains all values measured for control samples (untreated). In red the distribution of the gene expressiion of all samples treated with 15 drugs is shown.
```{r }
plot(density(NCI_TPW_gep_untreated), 
     "Density plot of gene expression", 
     cex.main = 1.2) #sets size of main
lines(density(NCI_TPW_gep_treated), col = "red")
legend("topright", 
       legend = c("untreated", "treated"), 
       col = c("black", "red"), #colors
       pch = 15) #filled square to show color in legend
```

As expected, there can be hardly seen any difference between both curves, so the distribution is nearly the same. The main reason for that is that the gene expression of most of the 13299 genes does hardly or not at all change due to the drug. Ideally the drug should only affect genes, which have an impact specifically on cancer cells and allow them to divide endless. On the other side, other genes should not be affected to remain a functional cell. Furthermore, an upregulation of some genes and a downregulation of others could compensate each other in the density plot. 

### Gene expression profile for untreated celllines {#1c}

In a next step the gene expression profile of each untreated sample was visualized in a **boxplot** to look, whether the expression profiles look the same over all samples or whether normalization is needed. 

```{r warning = FALSE }
#par used to set graphical parameters
#mar gives the margin size
#xpd = "TRUE" to plot legend outside of the plot
par(mar = c(4, 4, 4, 7.5), xpd = "TRUE")
boxplot(NCI_TPW_gep_untreated, 
        xaxt = "n", #removes labels on x-axis
        ylab = "Gene expression profile", 
        vertical =  T, 
        cex.main = 1.2,
        main = "Gene expression profile of untreated NCI60 celllines")
title(xlab = "Samples", line = 1.0) #used to create a xlab nearer to the axis
```

In the boxplot differences occuring after a certain number of samples can be observed. An explanation for that could be that the gene expression of the samples was measured at different points of time or even at different laboratories. This raised the question, whether these batches match with the 15 drugs these control measurements of untreated expressions were made. Therefore, the boxes were **colored according to the drug** the control was used for.   

```{r warning = FALSE}
par(mar = c(4, 4, 4, 7.5), xpd = "TRUE")
boxplot(NCI_TPW_gep_untreated, 
        xaxt = "n", #removes labels on x-axis
        ylab = "Gene expression profile", 
        vertical =  T, 
        main = "Gene expression profile of untreated NCI60 celllines", 
        cex.main = 1.2,
        boxcol = color_vector_drug)
title(xlab = "Samples", line = 1.0) #used to create a xlab nearer to the axis
legend("topright", 
       legend = names(color_palette_drug), 
       col = color_palette_drug,
       inset = c(-0.22, 0), #moves legend to the right
       pch = 19) #type of points in legend
```

Since the batches exactly match the different drugs for which the untreated expression was determined, a **normalization** is necessary if the values over the various drugs should be comparable. 

```{r warning = FALSE}
#each sample should have mean 0 and sd 1 in the untreated and treated table
#this is achieve by substracting the mean and dividing through the standard deviation of the sample
untreated_normalized <- apply(NCI_TPW_gep_untreated, 2, function(x){ 
  #for all samples (columns in NCI_TPW_gep_untreated)
  (x - mean(x)) / sd(x)
})
treated_normalized <- apply(NCI_TPW_gep_treated, 2, function(x){
  (x - mean(x)) / sd(x)
})

#the fold change is calculated from the normalized data
FC_normalized <- treated_normalized - untreated_normalized

#boxplot of normalized untreated values
par(mar = c(4, 4, 4, 7.5), xpd = "TRUE")
boxplot(untreated_normalized, 
        xaxt = "n", #removes labels on x-axis
        ylab = "Gene expression profile", 
        vertical =  T, 
        main = "Normalized gene expression profile of untreated NCI60 celllines",
        cex.main = 1.2, 
        boxcol = color_vector_drug)
title(xlab = "Samples", line = 1.0) #used to create a xlab nearer to the axis
legend("topright",
       legend = names(color_palette_drug), 
       col = color_palette_drug, 
       pch = 19, #type of points in legend
       inset = c(-0.22, 0)) #moves legend to the right
```

### Principal Component Analysis {#1d}
A principal component analysis is used for dimensionality reduction. With these technique it is possible to depict most of the variance observed in the gene expression changes due to drug treatment (foldchange) over all samples. The points were colored firstly according to drug and secondly according to cancertype to see whether there are clusters corresponding to drug treatment or cancertype. 

#### Coloring according to drug
```{r warning = FALSE, fig.height = 10, message = FALSE}
library(factoextra)

#prcomp calculates principal components
pca <- prcomp(FC_normalized)

#set graphical parameters
#mfrow: combine multiple plots, here 2 rows and 1 column
par(mar = c(4, 4, 4, 7.5), mfrow = c(2, 1))

#PC1 and PC2
plot(pca$rotation[,1], 
     pca$rotation[,2], 
     col = color_vector_drug, 
     pch = 19, 
     #2nd column of get_eigenvalue contains percentage of explained variance
     #round(x, digits to round): here round explained variance to one digit
     xlab = paste("PC1 (", round(get_eigenvalue(pca)[1,2], 1), "%)"), 
     ylab = paste("PC2 (", round(get_eigenvalue(pca)[2,2], 1), "%)"))
#create legend centered over both plots on the right side
legend("topright", 
       legend = names(color_palette_drug), 
       col = color_palette_drug, 
       pch = 19, 
       xpd = "TRUE",
       inset = c(-0.22, 0.7)) #move legend to the right and down
#Title for both plots together: mtext = margin text, side = 3 (upside)
mtext("PCA of FC colored according to drug", 
      side = 3, 
      line = -2.5, #giving the position as a margin line
      cex = 1.2,
      font = 2, #bold
      outer = TRUE)

#PC2 and PC3
plot(pca$rotation[,2], 
     pca$rotation[,3], 
     col = color_vector_drug, 
     pch = 19, 
     xlab = paste("PC2 (", round(get_eigenvalue(pca)[2,2], 1), "%)"), 
     ylab = paste("PC3 (", round(get_eigenvalue(pca)[3,2], 1), "%)"))

```

In the PCA plot it can be seen that the celllines treated with the same drug cluster in certain areas. Especially the fold change of the celllines treated with bortezomib, doxorubicin and vorinostat cluster further apart from the rest. The samples of erlotinib, on which we will focus in the second part are mostly clustered in the middle of the plot. 

#### Coloring according to cancertype
```{r warning = FALSE, fig.height = 10}
#set graphical parameters
#mfrow: combine multiple plots, here 2 rows and 1 column
par(mar = c(4, 4, 4, 7), mfrow = c(2, 1))
#PC1 and PC2
plot(pca$rotation[,1], 
     pca$rotation[,2], 
     col = color_vector_cancertype, 
     pch = 19, 
     #2nd column of get_eigenvalue contains percentage of explained variance
     #round(x, digits to round): here round explained variance to one digit
     xlab = paste("PC1 (", round(get_eigenvalue(pca)[1,2], 1), "%)"), 
     ylab = paste("PC2 (", round(get_eigenvalue(pca)[2,2], 1), "%)"))
legend("topright",
       legend = names(color_palette_cancertype), 
       col = color_palette_cancertype, 
       pch = 19, 
       xpd = "TRUE",
       inset = c(-0.19, 0.9))
#PC2 and PC3
plot(pca$rotation[,2], 
     pca$rotation[,3], 
     col = color_vector_cancertype, 
     pch = 19, 
     xlab = paste("PC2 (", round(get_eigenvalue(pca)[2,2], 1), "%)"), 
     ylab = paste("PC3 (", round(get_eigenvalue(pca)[3,2], 1), "%)"))

#Title for both plots together: mtext = margin text, side = 3 (upside)
mtext("PCA of FC colored according to cancertype", 
      side = 3, 
      line = -2.5, #giving the position as a margin line
      cex = 1.2,
      font = 2, #bold
      outer = TRUE)

rm(pca)
```

The colors showing which cancertype a cellline belongs to seem rather random distributed in the PCA plot. No clustering between the celllines beeing part of the same cancertype can be observed. 

### Most regulated genes {#1e}
In the last part of the broad analysis, we analysed which genes were most regulated over all drug treatments. For hat the mean fold change for each gene over all samples was calculated and the 20 genes with the highest mean are shown in a **barplot**. The mean fold change was calculated from the absolute numbers of the fold change, since otherwise positive and negative values would compensate each other and the mean would probably be around zero.  
```{r}
#calculating the mean FC over positive FC values
mean_FC_abs <- apply(abs(fold_changes), 1, mean)
mean_FC_abs <- sort(mean_FC_abs, decreasing = TRUE)
mean_FC_abs <- as.data.frame(cbind(genes = names(mean_FC_abs[1:10]), abs_foldchange = mean_FC_abs[1:10]))
mean_FC_abs$abs_foldchange <- as.numeric(as.character(mean_FC_abs$abs_foldchange))
ggplot(data = mean_FC_abs, aes(x = genes, y = abs_foldchange)) +
    geom_bar(stat = "identity")+
    ggtitle("Genes with highest mean in absolute FC")+
    scale_x_discrete(limits = rev(rownames(mean_FC_abs)))+ #sort celllines by increasing values
    coord_flip()

```

**Boxplot** of genes with highest mean FC
```{r}
#FC_samples_with_highest_mean_FC contains the gene expression of the 20 biomarkers (20 columns) of all samples(819 rows) 
FC_samples_with_highest_mean_FC <- data.matrix(as.data.frame(sapply(rownames(mean_FC_abs), function(x){
  fold_changes[which(x == rownames(fold_changes)),]
})))

par(mar = c(8, 2, 2, 2))
boxplot(FC_samples_with_highest_mean_FC, 
      ylab = "foldchange", 
      main = "Boxplot of foldchange of the genes with highest mean FC", 
      cex.main = 1.2,
      las = 2,
      outline = FALSE) 
```




## **Specific analysis: Erlotinib **

## 2. Milestone: find most affected cell lines

### Data preparation 
**Erlotinib treated** cell lines are selected and the matrix of the foldchange is normalized

```{r }
#new matrix only with samples/columns treated with erlotinib  (e=erlotinib)
e_treated <- NCI_TPW_gep_treated[,grep ("erlotinib", colnames(NCI_TPW_gep_treated))]
e_untreated <- NCI_TPW_gep_untreated[,grep ("erlotinib", colnames(NCI_TPW_gep_treated))]

#z-Transformation of e_treated/e_untreated to get mean=0 and sd=1, equivalent to 
e_treated <- scale(e_treated, scale=TRUE)
e_untreated <- scale(e_untreated, scale = TRUE)

#colnames of e_foldchange with cellline instead of complete sample name
cellline <- sapply(colnames(e_treated), function(x){
  annotation[x,"Cellline"]
  }) 
colnames(e_treated) <- cellline
colnames(e_untreated) <- cellline

# calculate foldchange by substracting e_untreated from e_treated
e_foldchange <- e_treated - e_untreated

```

### Table of 15 cell lines   
Cell lines, which showed the highest variance over all genes were selected

```{r comment=NA, warning=FALSE}
#select 15 cell lines with highest variance (greater than 75% quantile, sorted by decreasing value)
var_cell_line <- apply(e_foldchange, 2, var)
cell_line_var_greater_75quantile <- sort(var_cell_line [which (abs(var_cell_line) > quantile(abs(var_cell_line), 0.75))], decreasing = TRUE)
cell_line_var_greater_75quantile <- round(cell_line_var_greater_75quantile, digits=5)

#add column with cell line for top15 celllines
celllines_top15 <- as.data.frame(names(cell_line_var_greater_75quantile))

#add column with cancertype for top15 celllines
annotation_cancertype <- annotation[which(annotation[, "Drug"] == "erlotinib"), "Cancertype"]
names(annotation_cancertype) <- colnames(e_foldchange)
cancertypes_top15 <- sapply(names(cell_line_var_greater_75quantile), function(x){
  annotation_cancertype[which(x == names(annotation_cancertype))]
})
table_cell_lines_var_top15 <- cbind(1:nrow(celllines_top15), celllines_top15, 
                                    cell_line_var_greater_75quantile, cancertypes_top15)

colnames(table_cell_lines_var_top15) <- c("Rank", "Cellline", "Variance", "Cancertype")
rownames(table_cell_lines_var_top15) <- c(1:nrow(celllines_top15))

library(formattable)
formattable(table_cell_lines_var_top15)
```

### PCA
PCA is performed to find cell lines, which differ most from the other cell lines
```{r message=FALSE, warning=FALSE}
#PCA with transformed matrix (each point represents a sample):
par(mar= c(4, 4, 4, 7))
pca <- prcomp(e_foldchange)
plot(pca$rotation[,1], 
     pca$rotation[,2], 
     col=color_vector_cancertype, 
     pch=19, 
     xlab = "PC1", 
     ylab="PC2", 
     main = "PCA of cell lines",
     cex.main = 1.2)
legend("topright", 
       legend = names(color_palette_cancertype), 
       col = color_palette_cancertype, 
       pch = 19, 
       xpd = TRUE, 
       inset = c(-0.18, 0))
#label points
celllines_PCA <- names(pca$rotation[ , 1])[pca$rotation[ , 1] > 0.14]
text(pca$rotation[ ,1][celllines_PCA], 
     pca$rotation[ ,2][celllines_PCA], 
     celllines_PCA,
     pos = 2,
     cex = 0.6)
```
### Which pathways are affected?

The aim of our last milestone was to identify the pathways which are most regulated due to erlotinib. We used two methods to create a heatmap of the pathways. In the first one Supplementary Table S2 from the NCI TPW was used. In this table 5-15 genes are listed for each of the pathways. The second method was to use the R package progeny, which scores 100 genes per pathway to calculate the pathway activity and should explain better the pathway activity since more data is regarded. 

### 1. Pathways according Supplementary Table S2
First the genes listed for each pathway were stored in one vector. These pathway vectors were than combined in one table called pathways. 
```{r}
#assign genes to pathways (as in supplementary material)
MAPK <- c("AURKA", "AURKB", "SON", "CENPA", "KIF11", "DUSP6", "TPX2", "EGR1")
AKT_PI3K <- c("CFLAR", "XIAP", "BIRC5", "BIRC3", "GADD45A", "MCL1", "BCL2", 
              "BCL2L1", "HIF1A", "AR", "STAT3", "IL6", "JUN", "FOS")
  #AP1 for AKT_PI3K excluded (genename does not exist in FC)
  #do they mean with AP1 these 5 genes? AP1AR, AP1B1, AP1G1, AP1G2, AP1M2, AP1S1, AP1S2
  #same problem for VEGF --> VEGFA, VEGFB, VEGFB
Cell_Cycle_Checkpoint <- c("CHEK1", "CHEK2", "TP53", "MDM2", "CDKN1A", "CCNE1", "CDK2", 
                           "CDC25A", "SMC1A", "CCNB1", "CDK1", "CDC25B", "CDC25C", 
                           "PLK1", "WEE1", "CCND1")
JAK_STAT <- c("SOCS1", "NMI", "BCL2L1", "CDKN1A", "MYC")
Immunity_Related <- c("BCL2L1", "XIAP", "BIRC5", "CFLAR", "IL6", "IL1B", "TNF")
  #PTGS does not exist
DNA_repair <- c("XRCC6", "PRKDC", "DCLRE1C", "XRCC4", "LIG4", "BRCA1", 
                "RAD52", "BRCA2", "RAD54L", "ATM", "ATR", "PARP1")
  #NHEJ1 does not exist
DNA_damage <- c("TP53", "FAS", "BAX", "PMAIP1")
  #BBC3 & ARG do not exist
ER_Stress_Survival <- c("HSPA5", "HSP90B1", "XBP1", "P4HB", "ATF4", "GADD45A")
ER_Stress_Apoptotic_Response <- c("ATF3", "DDIT3", "TNFRSF10B", "TRIB3", "BCL2L11", "CASP2")
  #BBC3 & GADD34 do not exist
Apoptosis_extrinsic_activation <- c("BID", "FAS", "CASP8", "CASP9", "APAF1")
Apoptosis_intrinsic_activation <- c("BAX", "BAK1", "BID", "PMAIP1", 
                                    "CASP6", "CASP9", "APAF1")
  #BBC3 does not exist
Autophagy_recycling_starvation <- c("MAP1LC3B", "ULK1", "ATG13", "BECN1", 
                                    "SQSTM1", "ATG5", "ATG12", "CTSB")
Autophagy_toxic <- c("SQSTM1", "ATG7", "RIPK1", "CTSB")

#create named list of all pathways
pathways <- list(MAPK = MAPK, 
                 AKT_PI3K = AKT_PI3K, 
                 Cell_Cycle_Checkpoint = Cell_Cycle_Checkpoint, 
                 JAK_STAT = JAK_STAT,
                 Immunity_Related = Immunity_Related,
                 DNA_repair = DNA_repair,
                 DNA_damage = DNA_damage,
                 ER_Stress_Survival = ER_Stress_Survival,
                 ER_Stress_Apoptotic_Response = ER_Stress_Apoptotic_Response,
                 Apoptosis_extrinsic_activation = Apoptosis_extrinsic_activation, 
                 Apoptosis_intrinsic_activation = Apoptosis_intrinsic_activation, 
                 Autophagy_recycling_starvation = Autophagy_recycling_starvation,
                 Autophagy_toxic = Autophagy_toxic) 
rm(MAPK, AKT_PI3K, Cell_Cycle_Checkpoint, JAK_STAT, Immunity_Related, DNA_repair, 
   DNA_damage, ER_Stress_Survival, ER_Stress_Apoptotic_Response, 
   Apoptosis_extrinsic_activation, Apoptosis_intrinsic_activation, 
   Autophagy_recycling_starvation, Autophagy_toxic)
```

This pathway table was then used to create the heatmap_data table, in which the mean expression over all genes assigned to a pathway is calculated for each cellline.
```{r}
#calculate mean FC over genes of one pathway for each sample
heatmap_data <- sapply(1:length(pathways), function(x){ #for each pathway
  sapply(1:ncol(e_foldchange), function(y){ #for each sample
    #calculate mean FC of genes of one pathway
    mean(e_foldchange[pathways[[x]], y]) 
  })
})

colnames(heatmap_data) <- c(names(pathways))
rownames(heatmap_data) <- colnames(e_foldchange)
```

Proof how many clusters are needed with an elbow plot
```{r,  fig.height = 3, warning = FALSE, message = FALSE}
#Elbow plot
library(factoextra)
fviz_nbclust(heatmap_data, 
             FUN = hcut, 
             method = "wss") + #within cluster sums of squares
  labs(title = "Elbow plot: optimal number of cellline clusters")

fviz_nbclust(t(heatmap_data), 
             FUN = hcut, 
             method = "wss") +
  labs(title = "Elbow plot: optimal number of pathway clusters")
```


Create a heatmap with the package pheatmap (pretty heatmap):
```{r, fig.height = 6, warning = FALSE}
library(pheatmap)
library(RColorBrewer)
annotation_cancertype_df <- as.data.frame(annotation_cancertype)
#Scaling of pathways
heatmap_data <- scale(heatmap_data, scale=TRUE)

#Coloring according to quantiles
color_quantiles <- quantile(heatmap_data, seq(0, 1, 0.1))

#generate heatmap with colored bars according to clusters
pheatmap(t(heatmap_data),
         clustering_method = "ward.D2",
         annotation_col = annotation_cancertype_df,
         cutree_rows = 3, #makes white spaces between clusters
         cutree_cols = 3,
         main = "Affected pathways by erlotinib",
         mainsize = 1.2,
         show_colnames = FALSE,
         cellwidth = 4,
         cellheight = 15, 
         fontsize = 10,
         fontsize_row = 12,
         breaks = color_quantiles,
         col = rev(brewer.pal(10, "RdBu")))
```

### 2. Heatmap with PROGENy

Using PROGENY, which scores the 100 most important genes for each pathway to depict its activity.
```{r warning = FALSE}
library(progeny)
progeny_heatmap <- progeny(e_foldchange)
```

Proof how many clusters are needed with an elbow plot
```{r, fig.height = 3, warning = FALSE}
#Elbow plot
library(factoextra)
fviz_nbclust(progeny_heatmap, 
             FUN = hcut, 
             method = "wss") + #within cluster sums of squares
  labs(title = "Elbow plot: optimal number of cellline clusters")

fviz_nbclust(t(progeny_heatmap), 
             FUN = hcut, 
             method = "wss") +
  labs(title = "Elbow plot: optimal number of pathway clusters")
```


Clustering of celllines according to dendrogramm and cancertype
```{r}
library(dendextend)
cellline_clustering <- hclust(dist(progeny_heatmap), method = "ward.D2")
cellline_groups <- as.data.frame(cutree(tree = as.dendrogram(cellline_clustering), k = 2))
cellline_clusters <- as.data.frame(cbind(cellline_groups, annotation_cancertype_df))
colnames(cellline_clusters) <- c("Cellline cluster", "Cancertype cluster")
```

Create heatmap
```{r, fig.height = 6}
#Coloring according to quantiles
color_quantiles <- quantile(progeny_heatmap, seq(0, 1, 0.1))

par(mar = c(8, 2, 2, 2))
pheatmap(t(progeny_heatmap),
         clustering_method = "ward.D2",
         annotation_col = annotation_cancertype_df,
         cutree_rows = 2,
         cutree_cols = 2,
         main = "Affected pathways by erlotinib (PROGENy)",
         mainsize = 1.2, 
         show_colnames = FALSE,
         cellwidth = 5,
         cellheight = 20, 
         fontsize = 10,
         fontsize_row = 14,
         breaks = color_quantiles,
         col = rev(brewer.pal(10, "RdBu")))
```

### Venn Diagramm 

Venn diagramm of celllines from heatmap cluster 2, PCA and top15 variance celllines
```{r message = FALSE}
library(VennDiagram)

heatmap_genes_cluster2 <- rownames(cellline_clusters)[which(cellline_clusters[, 1] == 2)] #genes from cluster 2

venn.list <- list("Heatmap Cluster 2" = heatmap_genes_cluster2,
                  "Top15 variance" = table_cell_lines_var_top15[, 2], #column 2 contains celllines
                  "PCA" = celllines_PCA)

venn.plot <- venn.diagram(
  x = venn.list,
  filename = NULL, 
  fill = c("blue", "red", "green"), 
  main = "Venn Diagramm of most regulated celllines", 
  main.fontface = 2,
  main.cex = 1.2,
  main.fontfamily = "sans", # font type of title is Arial 
  cat.fontfamily = "sans",
  cat.cex = 0.9,
  fontfamily = "sans",
  cat.just = list(c(0.5, -40), c(0.2, -1), c(0,0)));
grid.draw(venn.plot);

#Save the ten celllines contained in all three vectors
celllines_overlap <- calculate.overlap(venn.list)[[1]] #get first list, which is the intersection of all three circles
```

## 3. Milestone: Identify biomarkers
As third milestone, we want to select those genes, which are most regulated by erlotinib. Therefore, we perform a MA plot to illustrate and identify genes, with the highest fold change. Thereafter, we further reduce those genes according to their significance using a volcano plot. To illustrate, how many genes are left out due to their lower significance, we draw a venn diagram. Those genes, which have a high fold change and a high significance represent our biomarkers. Selecting the biomarkers, we draw a density plot to compare the gene expression before and after treatment. 

### Select biomarkers with high foldchange
Firstly, we draw an **MA plot** to compare the fold change to the mean expression of all genes. Thereby, we select only those genes, which have a higher mean foldchange than 0.25 or a lower mean foldchange than -0.25.
```{r message = FALSE, warning=FALSE}
#load ggplot2 and ggrepel
library(ggplot2)
library(ggrepel)

#create data frame with variables M and A of MA-plot as well as one column, which shows, if absolute fold change is greater than 0.25 
M <- e_foldchange # M= log2(treated) - log2 (untreated)
A <- 1/2*(e_treated+ e_untreated) # average log2-expression value A = 1/2 (log2(treated)+log2(untreated))
MA <- cbind("M"= rowMeans(M), "A" = rowMeans(A))
rm(M, A)
MA <- as.data.frame(MA)
MA$High_foldchange <- ifelse(MA$M > 0.25 | MA$M < -0.25, "FC_abs > 0.25", "FC_abs < 0.25")

#label genes of MA plot, which have an absolute foldchange greater than 0.5 
MA_labeled <- MA[which(abs(MA[ , "M"]) > 0.5) , ]

#create MA plot, where genes with FC_abs > 0.25 are colored and those genes with FC_abs > 0.5 are labeled
ggplot(data = MA)+ 
  aes(x = A, y = M, color = High_foldchange)+
  geom_point()+
  xlab("mean expression")+
  ylab("log fold change")+
  ggtitle("MA plot of all genes")+
  geom_text(data = MA_labeled, aes(A, M, label = rownames(MA_labeled)), hjust = 0, nudge_x = 0.1)+
  theme(plot.title = element_text(size = 13, face = "bold", hjust = 0.5)) # change the size and face (bold) of the title and center it (hjust=0.5)

#save highlighted biomarkers, obtained through MA plot in biomarkers_MA
biomarkers_MA <- rownames(MA)[which(abs(MA$M) > 0.25)]
```

### Select biomarkers with high foldchange and high significance
We then create a **volcano plot** to find the genes, which have in addition to a high fold change, also a very high significance.
```{r warning = FALSE, message = FALSE}
#load libraries needed for EnhancedVolcano
library(ggplot2)
library(ggrepel)
library(EnhancedVolcano)

#calculate mean foldchange over all cell lines for each gene
e_foldchange_mean_over_cell_lines <- rowMeans(e_foldchange) 

#determine p-value for a paired two-sample t-test between gene expression of treated and untreated samples
p_values <- sapply(rownames(e_treated), function(x) {
  t.test(e_treated[x,], e_untreated[x,],paired= T)$p.value}) # perform t-test and save p-values of each gene in p_values-vector
FDR_values <- p.adjust(p_values, method = "BH", n = length(p_values)) #calculate FDR with benjamini-hochberg (BH); selecting significance of genes with p-value, would give us more false-positives, because most of the genes are not regulated by erlotinib

#create matrix with one column for mean foldchange and one column for FDR_values for every gene
volcano_plot_mat <- cbind(e_foldchange_mean_over_cell_lines, FDR_values)

#draw volcano plot, where those genes with FC_abs > 0.25 and FDR_value > 10e^-9 are labeled and highlighted in red 
EnhancedVolcano(volcano_plot_mat, 
                lab = rownames(volcano_plot_mat),
                x = "e_foldchange_mean_over_cell_lines", 
                y = "FDR_values",
                title = "Volcano plot of all genes",
                titleLabSize = 13,
                ylab = bquote(~FDR~value),
                pCutoff = 10e-9, #threshold for coloring significant ones
                FCcutoff = 0.25, #threshold for coloring high FC
                transcriptPointSize = 2,
                transcriptLabSize = 3,
                legendPosition = "right",
                legendLabSize= 10,
                axisLabSize = 10 
                 )
#save highlighted biomarkers, obtained through volcano plot in biomarkers_volcano
biomarkers_volcano <- rownames(volcano_plot_mat)[which(abs(volcano_plot_mat[, 1]) >  0.25  & volcano_plot_mat[, 2] < 10e-9)]
```


### Compare selected biomarkers 
We use a **Venn Diagram** to compare the most regulated genes obtained through the MA plot with those obtained through the volcano plot. This shows us, how many genes were sorted out due to a lower FDR_value.
```{r warning = FALSE, message = FALSE}
#load Venn Diagram
library(VennDiagram)

#draw Venn Diagram with biomarkers of MA and Volcano plot
par(oma = c(2, 2, 2, 2))
venn.plot <- venn.diagram(
  x = list(
    "Volcano Plot" = biomarkers_volcano,
    "MA Plot" = biomarkers_MA
    ),
  filename = NULL, 
  fill = c("blue", "red"), 
  main = "Venn Diagramm of selected biomarkers", 
  main.fontface = 2,
  main.cex = 1.2,
  main.fontfamily = "sans", # font type of title is Arial 
  cat.fontfamily = "sans",
  cat.cex = 0.9,
  fontfamily = "sans",
  ext.text = FALSE,
  cat.just = list(c(-0.8,2), c(1,0)));
grid.draw(venn.plot);
```

### Compare gene expression of biomarkers before and after treatment  
To sum up the milestone, we draw a **density plot** only with the biomarkers identified after the volcano plot. This shows us, how the gene expression before and after the erlotinib treatment changed. Therefore, we have to separate between up- and downregulated to make sure that positive and negative fold changes do not cancel each other out.
```{r}
#create new vector, where up- and only downregulated volcano biomarkers are separated
biomarkers_volcano_up <- rownames(volcano_plot_mat)[which(volcano_plot_mat[, 1] > 0.25)]
biomarkers_volcano_down <- rownames(volcano_plot_mat)[which(volcano_plot_mat[, 1] < -0.25)]

#Density plot with upregulated biomarkers_volcano to compare untreated with treated gene expression
plot(density(e_untreated[biomarkers_volcano_up, ]), "Density plot of gene expression of upregulated biomarkers", cex = 1.2, col = "green", ylim= c(0.0, 0.5))

lines(density(e_treated[biomarkers_volcano_up, ]), col = "red")
legend("topright", legend = c("untreated", "treated"), col = c("green", "red"), pch = 15)

#Density plot with downregulated biomarkers_volcano to compare untreated with treated gene expression
plot(density(e_untreated[biomarkers_volcano_down, ]), "Density plot of gene expression of downregulated biomarkers", cex = 1.2, col = "green", ylim= c(0.0, 0.7))

lines(density(e_treated[biomarkers_volcano_down, ]), col = "red")
legend("topright", legend = c("untreated", "treated"), col = c("green", "red"), pch = 15)
```
To conclude this milestone, we end up with 63 biomarkers, which have an absolute fold change greater than 0.25 and a FDR-value greater than 10e^-9. As the density plots show us, with only the biomarkers selected, we this time see a considerable difference between theuntreated and treated gene expression.


## 4. Milestone - Does the gene expression correlate with the drug sensitivity?
For the forth milestone, we focus on the erlotinib target EGFR and its regulated gene EGR1. We there want to compare the GI50-values of all cell lines, which show, how much the cell growth is inhibited. This in turn represents, how sensitive the cell line is to erlotinib. Thereby, we hope to see a correlation between the untreated gene expression of EGFR and the GI50 values, because the erlotinib receptor EGFR should be more expressed in erlotinib sensitive cells. Thereafter, we correlate the fold change of EGR1 with the GI50-values. We thereby expect, that the fold change of EGR1 decreases most in erlotinib sensitive cell lines.

### Data preparation 
```{r}
# create vector of NegLogGI50 of erlotinib, which only includes cell lines, which also appear in e_foldchange
NegLogGI50_59_celllines <- NegLogGI50 ["erlotinib", -c(8,29)] # remove cell line "COLO-205" and "MDA-N"

# multiply the NegLogGI5= by -1 to get the LogGI50-values
LogGI50_59_celllines <- NegLogGI50_59_celllines * (-1)


#change colnames of e_untreated with cellline instead of complete sample name
colnames(e_untreated) <- cellline

#create color vector to color erlotinib treated cell lines according to cancertype
e_color_cancertype <- color_vector_cancertype[grep("erlotinib", names(color_vector_cancertype), value = TRUE)]
```

### EGFR gene expression in the untreated celllines against GI50-values   
Firstly, we draw a **scatter plot** to show, if the expression level of EGFR without treatment correlates with the sensitivities of the cell lines. Performing Pearson correlation, we hope to see a clear correlation with a correlation value close to -1. Moreover, we plot a linear regression line, to see how well the line describes the correlation and if we can deduce the sensitivity of the cell line from the untreated gene expression of EGFR. 
```{r pressure, warning = FALSE}
#draw scatter plot of  untreated gene expression level of EGFR aginst LogGI50 and color them according to the cancer type
par(mar = c(4, 4, 4, 7), xpd = "TRUE")
plot(LogGI50_59_celllines, e_untreated ["EGFR",], 
      col = e_color_cancertype, 
      pch = 19, 
     xlab = "logGI50", 
     ylab = "EGFR Expression (untreated)",        
     main = "Expression of the epidermal growth factor receptor (Her 1)",
     cex.main = 1.2)

# add linear regression line
clip(-7.13, -3.88, -1, 2) #set clipping limit that abline is not longer than the plot itself 
abline(lm (e_untreated["EGFR", ]~ LogGI50_59_celllines))

# add legend to associate each color with a cancertype
legend("topright", 
    legend = names(color_palette_cancertype), 
    col = color_palette_cancertype, 
    pch = 19,
    inset = c(-0.18, 0),
    xpd = TRUE)

# label cell lines, which are most sensitive and have a high e_untreated expression of EGFR 
labeled_celllines_EGFR <- names(LogGI50_59_celllines)[LogGI50_59_celllines < - 5.5
                                                        & e_untreated ["EGFR", ] > 0]
text(LogGI50_59_celllines[labeled_celllines_EGFR], e_untreated ["EGFR", labeled_celllines_EGFR], 
     labels = labeled_celllines_EGFR,
     cex = 0.7,
     pos = 3)

#perform Pearson correlation, to see how well LogGI50 and the foldchange correlate with each other 
cor_EGFR <- cor.test(LogGI50_59_celllines, e_foldchange["EGFR",], method = "pearson")
cor_EGFR_estimate <- round(cor_EGFR$estimate, digits=3)

# add title to scatter plot, which includes the correlation value
cor_text <- paste("r = ", cor_EGFR_estimate)
mtext(side = 1, line = -1.2, text = cor_text, adj = c(0.01))
```
Unfortunately, the correlation value is only -0.352 and especially the cell lines with a lower untreated gene expression do not correlate well with the sensitivity of the cell line. However, most of the labeled cell lines accumulate close to the regression line. 

### EGR1 foldchange against GI50-values 
We then draw a **scatter plot** to plot the fold change of EGR1 against the GI50-values, as this gene is regulated by EGFR. EGR1 is a transcriptional factor and is assocciated with the activiation of tumor suppressor genes like p53/TP53 and TGFB1, and plays an important role in the regulation of growth factor responses. This plot with EGR1 was also drawn for 6 h in the supplementary data provided by NCI Transcriptional Pharmacodynamics Workbench. We therefore, want to compare this with our scatter plot after 24h.

```{r figEGR1 , fig.show = "hold",  fig.width= 7, fig.height=7, warning = FALSE,  message=FALSE}
#Import picture shown in the Supplementary after 6h
url <- "https://raw.githubusercontent.com/datascience-mobi/project-02-group-04/master/Project%20proposal/EGR1%20expression.PNG"
include_graphics(url)

# create new color vector, which has the same colors as the imported picture with GI50 scatter plot of 6h
color_palette_cancertype_EGR1 <- c("red", "chartreuse", "orange", "green3", "turquoise", "hotpink", "blue", "purple", "deepskyblue")
names(color_palette_cancertype_EGR1) <- levels(cellline_annotation$Cancer_type)
color_vector_cancertype_EGR1 <- sapply(rownames(annotation), function(x){
  unname(color_palette_cancertype_EGR1[annotation[x, 3]]) })
e_color_cancertype_EGR1 <- color_vector_cancertype_EGR1[grep("erlotinib", names(color_vector_cancertype_EGR1), value = TRUE)]

#draw scatter plot of foldchange of EGR1 against LogGI50 and color them according to the cancer type
par(mar = c(4, 4, 4, 10), xpd = "TRUE")
pic2 <- {plot(LogGI50_59_celllines, e_foldchange ["EGR1",], 
     col = e_color_cancertype_EGR1, 
     pch = 19, 
     xlab = "logGI50", 
     ylab = "EGR1 Expression (log2, relative to control)",        
     main = "Erlotinib 24h", 
     cex.main = 1.2, 
     col.main = "deepskyblue")

# add legend to associate each color with a cancertype
segments(-7.11, 0, -3.88)
legend("topright", 
       legend = names(color_palette_cancertype_EGR1), 
       col = color_palette_cancertype_EGR1, 
       inset = c(-0.3, 0),
       pch = 19)


# label cell lines, which are most sensitive and have a very low foldchange of EGR1 
labeled_celllines <- names(LogGI50_59_celllines)[LogGI50_59_celllines < - 6
                                                        & e_foldchange["EGR1", ] < 0 
                                                 | LogGI50_59_celllines < -5 
                                                        & e_foldchange["EGR1", ] < -3]
text(LogGI50_59_celllines[labeled_celllines], e_foldchange ["EGR1", labeled_celllines],
     labels = labeled_celllines,
     cex = 0.7,
     pos = 4)

# add linear regression line
clip(-7.13, -3.88, -2, 0.5) #set clipping limit that abline is not longer than the plot itself 
abline(lm (e_foldchange["EGR1", ]~ LogGI50_59_celllines))

#perform Pearson correlation, to see how well LogGI50 and the foldchange correlate with each other 
cor_EGR1 <- cor.test(LogGI50_59_celllines, e_foldchange["EGR1",], method = "pearson")
cor_EGR1_estimate <- round(cor_EGR1$estimate, digits=3)

# add title to scatter plot, which includes the correlation value
cor_text <- paste("r = ", cor_EGR1_estimate, "(***)")
mtext(side = 3, line = -1.2, text = cor_text, adj = c(0.01))}

```
This time, the correlation value is much higher with r= 0.606 and apart from a few outliers, the sensitivity of the cell lines correlates quite well with the EGR1 fold change. Comparing 6 and 24h, the same correlation trend is seen in both scatter plots. However, the fold change of some of the most sensitive cell lines as "MDA-MB-468" or "IGR-OV1" changed dramatically between the two time points. 

## 5. Milestone - final results
### Venn Diagramm of celllines

Venn diagramm of celllines from heatmap cluster 2, PCA,  top15 variance celllines and correlation with GI50
```{r message = FALSE}
library(VennDiagram)

LogGI50_top10 <- names(sort(LogGI50_59_celllines)[1:10])

venn.plot <- venn.diagram(
  x = list(
    "Overlap of variance, 
    PCA and heatmap celllines" = celllines_overlap,
    "Top 10 LogGI50" = LogGI50_top10),
  filename = NULL, 
  fill = c("blue", "red"), 
  main = "Venn Diagramm of most regulated celllines", 
  main.fontface = 2,
  main.cex = 1.2,
  main.fontfamily = "sans", # font type of title is Arial 
  cat.fontfamily = "sans",
  cat.cex = 0.9,
  fontfamily = "sans", 
  cat.just = list(c(0.2,-1.5), c(1.2,-3)));
grid.draw(venn.plot);

celllines_final <- intersect(celllines_overlap, LogGI50_top10)

```

### Venn Diagramm of genes
```{r}
cor_all_genes <- sapply(rownames(e_foldchange), function(x){
  cor_test_one_gene <- cor.test(LogGI50_59_celllines, e_foldchange[x,], method = "pearson")
  cor_test_one_gene$estimate
})
cor_all_genes_sorted <- sort(cor_all_genes, decreasing = TRUE)
cor_top_500_genes <- cor_all_genes_sorted[1:500]

cor_biomarkers <- sapply(biomarkers_volcano, function(x){
  cor_test_one_biomarker <- cor.test(LogGI50_59_celllines, e_foldchange[x,], method = "pearson")
  cor_test_one_biomarker$estimate
})


par(oma = c(2, 2, 2, 2))
biomarkers_MA_vector <- rownames(MA_labeled)
venn.plot <- venn.diagram(
  x = list(
    "100 genes with highest correlation" = names(cor_top_500_genes),
    "correlation of biomarkers" = names(cor_biomarkers)
    ),
  filename = NULL, 
  fill = c("blue", "red"), 
  main = "Venn Diagramm of genes with highest GI50-foldchange correlation compared to biomarker", 
  main.fontface = 2,
  main.cex = 1.2,
  main.fontfamily = "sans", # font type of title is Arial 
  cat.fontfamily = "sans",
  cat.cex = 0.9,
  #cat.dist = 0.1, # distance between category and edge of circle
  fontfamily = "sans",
  cat.pos = c(0,0));
grid.draw(venn.plot);

biomarkers_final <- intersect(names(cor_top_500_genes), names(cor_biomarkers))

biomarkers_final <- gsub(pattern = ".cor", replacement = "", x = biomarkers_final)

```

### Boxplot 
Draw a boxplot of the **foldchange** of biomarkers
```{r}
# create a matrix foldchange_biomarkers_volcano, with the foldchange only of the biomarkers
foldchange_biomarkers <- sapply(biomarkers_final, function(x){
  e_foldchange[x, ]
})
boxplot(foldchange_biomarkers, ylab= "foldchange", 
        main= "Boxplot of foldchange of the volcano biomarkers", cex = 1.2, las=2)
```

Draw a boxplot of the **untreated vs. treated gene expression** of biomarkers 
```{r}
# create a matrix e_treated_biomarkers_volcano/ e_untreated_biomarkers_volcano, with the gene expression only of the biomarkers_volcano
e_treated_biomarkers_volcano <- sapply(biomarkers_final, function(x){
  e_treated[x, ]
})
e_untreated_biomarkers_volcano <- sapply(biomarkers_final, function(x){
  e_untreated[x, ]
}) 
colnames(e_treated_biomarkers_volcano) <- paste(colnames(e_treated_biomarkers_volcano),"Treated",
                                          sep = "_") #add treated to colnames

# create a matrix, which contains gene expression of untreated and treated and sort it after colnames
e_treated_untreated_biomarkers_volcano <- cbind (e_treated_biomarkers_volcano, e_untreated_biomarkers_volcano)
e_treated_untreated_biomarkers_volcano <- e_treated_untreated_biomarkers_volcano[,order(colnames(e_treated_untreated_biomarkers_volcano))]

# create a color vector, where untreated samples are green and treated ones are red
color_boxplot_e_treated_untreated <- sapply(colnames(e_treated_untreated_biomarkers_volcano), function(x) {
  ifelse(x %in% grep ("Treated",colnames(e_treated_untreated_biomarkers_volcano), value = TRUE),
         "red", "green")})

# boxplot, where treated and untreated are right next to each other
par(mar = c(10, 4, 2, 2))
boxplot(e_treated_untreated_biomarkers_volcano, 
        ylab = "gene expression (log2)", 
        main= "Boxplot of gene expression of the volcano biomarkers", 
        ceex = 1.2, 
        las = 2, 
        col = color_boxplot_e_treated_untreated)

```

### Correlation
```{r warning = FALSE}
par(mar = c(2, 6, 2, 13), xpd = "TRUE")

correlation_b <- c(e_foldchange[biomarkers_final [1],],e_foldchange[biomarkers_final [2],],e_foldchange[biomarkers_final [3],],e_foldchange[biomarkers_final [4],],e_foldchange[biomarkers_final [5],])
correlation_g <-rep(LogGI50_59_celllines,5)
correlation_c <- c(rep("green",59),rep("yellow",59),rep("red",59),rep("blue",59),rep("black",59))
correlation_bn <- c(rep("ATAD2",59),rep("E2F8",59),rep("ERCC6L",59),rep("MIR15A//DLEU2L//DLEU2",59),rep("MKI67",59))
correlation_biomarkers <- cbind (correlation_b, correlation_g, correlation_c, correlation_bn )

color_palette_biomarkers <- c("red","green","yellow" , "black", "blue" )
names(color_palette_biomarkers) <- biomarkers_final

plot(correlation_biomarkers[,"correlation_g"],correlation_biomarkers[,"correlation_b"], 
     col = correlation_c, 
     pch = 19,
     xlab = "logGI50", 
     ylab = "foldchange of biomarkers",        
     main = " Correlation between biomarkers and the GI50 values of the different celllines",
     cex.main = 1.2)

legend("topright", 
       legend = names( color_palette_biomarkers),
       col = color_palette_biomarkers,
       pch = 19,
       inset = c(-0.5, 0),
       xpd = TRUE)
```

### Single gene response plot 
**Barplot** of foldchange of our five biomarkers in our sensitive cell lines
```{r message = FALSE, warning = FALSE}
df_barplot_results <- as.data.frame(sapply (biomarkers_final, function(x) {
  e_foldchange[x, celllines_final]
}))


df_barplot_results <- as.data.frame(cbind(cellline = celllines_final, annotation_cancertype_df[celllines_final, ], df_barplot_results))

colnames(df_barplot_results)[2] <- "Cancertypes"

df_barplot_results <- df_barplot_results [order(df_barplot_results[,"Cancertypes"]),]

plot <- lapply(colnames(df_barplot_results)[3:7], function(gene){
  ggplot_title <- paste("Foldchange of" , gene)
  ggplot(data=df_barplot_results, aes(x=cellline, y= df_barplot_results[ ,gene], fill=Cancertypes)) +
    geom_bar(stat="identity")+
    scale_fill_manual(values=c("aquamarine", "forestgreen", "chartreuse", 
                               "cadetblue","purple", 
                               "firebrick1", "deepskyblue"))+
    ggtitle(paste0 (ggplot_title, "\n"))+
    theme(axis.title.x = element_blank())+
    #font("xy.text", size =10)+
    scale_x_discrete(limits= rownames(df_barplot_results))+
    coord_flip()
})


library(ggpubr)
ggarrange( plot[[1]], plot[[2]], plot[[3]], plot[[4]], plot[[5]], 
          ncol = 2, nrow = 3, common.legend = TRUE, legend = "top")
```
