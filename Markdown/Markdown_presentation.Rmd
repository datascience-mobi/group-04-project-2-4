---
title: 'Data analysis: Project 2 Group 4'
author: "Anna Muench, Ann-Sophie Kroell, Jana Braunger"
subtitle: ' Molecular Biotechnology, 4th term, Summer 2019'
output:
  html_document:
    hightlight: monochrome
    number_sections: no
    theme: yeti
    toc: yes
    toc_depth: 3
  pdf_document:
    toc: yes
    toc_depth: '3'
---
# **Broad Analysis**

```{r, include = FALSE}
# load required packages
library(knitr)
```

```{r setup, include = FALSE} 
# code and output not included in final file
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache = TRUE)
knitr::opts_chunk$set(fig.width = 9, fig.height = 6, fig.align = "center")
```


```{r include = FALSE}
NCI_TPW_gep_treated <- readRDS(url("https://ndownloader.figshare.com/files/14720180?private_link=db1411debcfbe2618d2f"))
NCI_TPW_gep_untreated <- readRDS(url("https://ndownloader.figshare.com/files/14720183?private_link=db1411debcfbe2618d2f"))
NCI_TPW_metadata <- read.delim("https://ndownloader.figshare.com/files/14720186?private_link=db1411debcfbe2618d2f")
NegLogGI50 <- readRDS(url("https://ndownloader.figshare.com/files/ 14720210?private_link=074e0120fe5e682f3d14"))
CCLE_basalexpression <- readRDS(url("https://ndownloader.figshare.com/files/14770127?private_link=fc0c71246dc192982a3c"))
CCLE_copynumber <- readRDS(url("https://ndownloader.figshare.com/files/14770130?private_link=fc0c71246dc192982a3c"))
CCLE_mutations <- readRDS(url("https://ndownloader.figshare.com/files/14770133?private_link=fc0c71246dc192982a3c"))
cellline_annotation <-read.delim("https://ndownloader.figshare.com/files/14768981?private_link=efb6a529eaf2d4dc6432")
drug_annotation <- read.delim("https://ndownloader.figshare.com/files/14768984?private_link=efb6a529eaf2d4dc6432")
```

##   _**1. Milestone: Broad analysis**_



```{r include = FALSE}
fold_changes <- NCI_TPW_gep_treated - NCI_TPW_gep_untreated
fold_changes <- as.data.frame(fold_changes)
```

 

```{r include = FALSE}
# SK-MEL-2_ is added as new factor 
levels(cellline_annotation$Cell_Line_Name) <- c(levels(cellline_annotation$Cell_Line_Name), 
                                                "SK-MEL-2_")
cellline_annotation[33, 1] <- "SK-MEL-2_"
# delete level SK-MEL-2 (otherwise we would have 62, instead of 61 levels)
cellline_annotation$Cell_Line_Name <- factor(as.character(
  cellline_annotation$Cell_Line_Name))
```
  

```{r include = FALSE}
# NSCL is added as new factor 
levels(cellline_annotation$Cancer_type) <- c(levels(cellline_annotation$Cancer_type), 
                                                "NSCL")
cellline_annotation[grep ("Non-Small Cell Lung", cellline_annotation$Cancer_type), "Cancer_type"] <- "NSCL"
# delete level Non-Small Cell Lung (otherwise we would have 16, instead of 15 levels)
cellline_annotation$Cancer_type <- factor(as.character(
  cellline_annotation$Cancer_type))
```
  
  

```{r include = FALSE}
sample_drug <- as.data.frame(sapply(levels(drug_annotation$Drug), grepl, 
                                    colnames(fold_changes), ignore.case = TRUE))
  # creates table with TRUE and FALSE for each sample (819 rows) and drug (15 columns)
rownames(sample_drug) <- colnames(fold_changes) # sample names as rownames
drugs <- as.vector(apply(sample_drug, 1, function(x){ # for each row of the sample_drug dataframe (=samples)
  # save the drug, which is the columnname in the column of the TRUE
  colnames(sample_drug[which(x)]) 
}))
```

  

```{r include = FALSE}
sample_cellline <- as.data.frame(sapply(levels(cellline_annotation$Cell_Line_Name), grepl, 
                                        colnames(fold_changes), ignore.case = TRUE)) 
  # creates table with TRUE and FALSE for each sample (819 rows) and cell line (61 columns)
rownames(sample_cellline) <- colnames(fold_changes) #sample names as rownames
cellline <- as.vector(unlist(apply(sample_cellline, 1, function(x){ 
  # for each row of the sample_drug dataframe (=samples)
  #save the cellline, which is the columnname in the column of the TRUE
  colnames(sample_cellline[which(x)])
})))

# annotation with drugs and cell lines in columns for each of the samples (819 rows)
annotation <- cbind("Drug" = drugs, "Cellline" = cellline)
rownames(annotation) <- colnames(fold_changes)
```



```{r include = FALSE}
cancertype <- sapply(annotation[, 2], function(x){ 
  # 2nd column of annotation contains cell line name of samples
  # save the cancertype the cell line belongs to 
  # by taking the word in cellline_annotation in column Cancer_type and in the row, where the cell line x stands
  cellline_annotation$Cancer_type[cellline_annotation$Cell_Line_Name == x]
})
cancertype <- as.vector(unlist(cancertype)) #to get a vector instead of a list of the cancertypes per sample

# add cancertype in annotation
annotation <- cbind(annotation, "Cancertype" = cancertype)
# remove all variables which are no longer needed
rm(drugs, sample_drug, cellline, sample_cellline, cancertype)
```


```{r include = FALSE}
# define a color palette with 15 chosen colors
color_palette_drug <- c("aquamarine", "brown", "forestgreen", "slategrey", 
                        "chartreuse", "darkgoldenrod1", "cadetblue","purple", 
                        "firebrick1", "deepskyblue", "gold", "violetred4", 
                        "deeppink", "plum2", "blue" )
# assign each color one of the 15 drugs
names(color_palette_drug) <- levels(drug_annotation$Drug)
  
# create vector containing a color name for each sample according to drug (length 819)
color_vector_drug <- sapply(rownames(annotation), function(x){ # for all samples x
  unname(color_palette_drug[annotation[x, 1]]) # first column of annotation contains drugs
})
```


```{r include = FALSE}
# define a color palette with 9 chosen colors
color_palette_cancertype <- c("aquamarine", "brown", "forestgreen", "chartreuse", 
                              "darkgoldenrod1", "cadetblue","purple", 
                              "firebrick1", "deepskyblue")

# each color is assigned the name of the 9 cancertypes
names(color_palette_cancertype) <- levels(cellline_annotation$Cancer_type)

# create vector containing a color name for each sample according to cancertype (length 819)
color_vector_cancertype <- sapply(rownames(annotation), function(x){
  unname(color_palette_cancertype[annotation[x, 3]]) #3rd columns of annotation contains cancertype 
})
```


```{r include = FALSE}
plot(density(NCI_TPW_gep_untreated), 
     "Density plot of gene expression", 
     cex.main = 1.2) # sets size of main
lines(density(NCI_TPW_gep_treated), col = "red")
legend("topright", 
       legend = c("untreated", "treated"), 
       col = c("black", "red"), # colors
       pch = 15) # filled square to show color in legend
```



```{r warning = FALSE, include = FALSE }
# par used to set graphical parameters
# mar gives the margin size
# xpd = "TRUE" to plot legend outside of the plot
par(mar = c(4, 4, 4, 7.5), xpd = "TRUE")
boxplot(NCI_TPW_gep_untreated, 
        xaxt = "n", # removes labels on x-axis
        ylab = "Gene expression profile", 
        vertical =  T, 
        cex.main = 1.2,
        main = "Gene expression profile of untreated NCI60 cell lines")
title(xlab = "Samples", line = 1.0) # used to create a xlab nearer to the axis
```

### Boxplot
```{r warning = FALSE, echo = FALSE}
par(mar = c(4, 4, 4, 7.5), xpd = "TRUE")
boxplot(NCI_TPW_gep_untreated, 
        xaxt = "n", # removes labels on x-axis
        ylab = "Gene expression profile", 
        vertical =  T, 
        main = "Gene expression profile of untreated NCI60 cell lines", 
        cex.main = 1.2,
        boxcol = color_vector_drug)
title(xlab = "Samples", line = 1.0) # used to create a xlab nearer to the axis
legend("topright", 
       legend = names(color_palette_drug), 
       col = color_palette_drug,
       inset = c(-0.22, 0), # moves legend to the right
       pch = 19) # type of points in legend
```


```{r warning = FALSE, include = FALSE}
# each sample should have mean 0 and sd 1 in the untreated and treated table
# this is achieve by substracting the mean and dividing through the standard deviation of the sample
untreated_normalized <- apply(NCI_TPW_gep_untreated, 2, function(x){ 
  # for all samples (columns in NCI_TPW_gep_untreated)
  (x - mean(x)) / sd(x)
})
treated_normalized <- apply(NCI_TPW_gep_treated, 2, function(x){
  (x - mean(x)) / sd(x)
})

# the fold change is calculated from the normalized data
FC_normalized <- treated_normalized - untreated_normalized

# boxplot of normalized untreated values
par(mar = c(4, 4, 4, 7.5), xpd = "TRUE")
boxplot(untreated_normalized, 
        xaxt = "n", # removes labels on x-axis
        ylab = "Gene expression profile", 
        vertical =  T, 
        main = "Normalized gene expression profile of untreated NCI60 cell lines",
        cex.main = 1.2, 
        boxcol = color_vector_drug)
title(xlab = "Samples", line = 1.0) # used to create a xlab nearer to the axis
legend("topright",
       legend = names(color_palette_drug), 
       col = color_palette_drug, 
       pch = 19, # type of points in legend
       inset = c(-0.22, 0)) # moves legend to the right
```

### Principal Component Analysis (PCA)

```{r warning = FALSE, message = FALSE, echo = FALSE}
library(factoextra)

# prcomp calculates principal components
pca <- prcomp(FC_normalized)

# set graphical parameters
# mfrow: combine multiple plots, here 2 rows and 1 column
par(mar = c(4, 4, 4, 7.5))# mfrow = c(2, 1))

# PC1 and PC2
plot(pca$rotation[,1], 
     pca$rotation[,2], 
     col = color_vector_drug, 
     pch = 19, 
     # 2nd column of get_eigenvalue contains percentage of explained variance
     # round(x, digits to round): here round explained variance to one digit
     xlab = paste("PC1 (", round(get_eigenvalue(pca)[1,2], 1), "%)"), 
     ylab = paste("PC2 (", round(get_eigenvalue(pca)[2,2], 1), "%)"))

# create legend centered over both plots on the right side
legend("topright", 
       legend = names(color_palette_drug), 
       col = color_palette_drug, 
       pch = 19, 
       xpd = "TRUE",
       inset = c(-0.22, 0)) #move legend to the right and down

# Title for both plots together: mtext = margin text, side = 3 (upside)
mtext("PCA of FC colored according to drug", 
      side = 3, 
      line = -2.5, # giving the position as a margin line
      cex = 1.2,
      font = 2, # bold
      outer = TRUE)

```


```{r warning = FALSE, fig.height = 10, include = FALSE}
# set graphical parameters
# mfrow: combine multiple plots, here 2 rows and 1 column
par(mar = c(4, 4, 4, 7), mfrow = c(2, 1))

# PC1 and PC2
plot(pca$rotation[,1], 
     pca$rotation[,2], 
     col = color_vector_cancertype, 
     pch = 19, 
     # get_eigenvalue is used to add percentage of explained variance in xlab and ylab
     # 2nd column of get_eigenvalue contains percentage of explained variance
     # round(x, digits to round): here round explained variance to one digit
     xlab = paste("PC1 (", round(get_eigenvalue(pca)[1, 2], 1), "%)"), 
     ylab = paste("PC2 (", round(get_eigenvalue(pca)[2, 2], 1), "%)"))

# create legend centered over both plots on the right side
legend("topright",
       legend = names(color_palette_cancertype), 
       col = color_palette_cancertype, 
       pch = 19, 
       xpd = "TRUE",
       inset = c(-0.19, 0.9))

# PC2 and PC3
plot(pca$rotation[,2], 
     pca$rotation[,3], 
     col = color_vector_cancertype, 
     pch = 19, 
     xlab = paste("PC2 (", round(get_eigenvalue(pca)[2,2], 1), "%)"), 
     ylab = paste("PC3 (", round(get_eigenvalue(pca)[3,2], 1), "%)"))

# Title for both plots together: mtext = margin text, side = 3 (upside)
mtext("PCA of FC colored according to cancertype", 
      side = 3, 
      line = -2.5, # giving the position as a margin line
      cex = 1.2,
      font = 2, # bold
      outer = TRUE)

```


# **Specific analysis: Erlotinib **

### Data preparation 

```{r }
# new matrix only with samples treated with erlotinib  (e = erlotinib)
e_treated <- NCI_TPW_gep_treated[ ,grep ("erlotinib", colnames(NCI_TPW_gep_treated))]
e_untreated <- NCI_TPW_gep_untreated[ ,grep ("erlotinib", colnames(NCI_TPW_gep_treated))]

# normalise matrix with scale 
e_treated <- scale(e_treated, scale = TRUE)
e_untreated <- scale(e_untreated, scale = TRUE)
```

```{r include = FALSE}
# echo: code not shown, but output
# load library formattable to create a table
library(formattable)
# show first 10 rows with erlotinib
formattable(as.data.frame(annotation[annotation[,1] == "erlotinib", ])) [1:10, ]
```


```{r include = FALSE}
#change colnames according to their cell line instead of their complete sample name
cellline <- sapply(colnames(e_treated), function(x){
  annotation[x,"Cellline"]
  }) 
colnames(e_treated) <- cellline
colnames(e_untreated) <- cellline

# calculate foldchange by substracting e_untreated from e_treated
e_foldchange <- e_treated - e_untreated
```

##   _**2. Milestone: Identify most affected cell lines**_

```{r comment = NA, warning = FALSE, include = FALSE}
# calculate the variance of each cell line
var_cellline <- apply(e_foldchange, 2, var)

# select 15 cell lines with highest variance (greater than 75% quantile, sorted by decreasing value)
cellline_var_greater_75quantile <- sort(var_cellline [which (abs(var_cellline) > quantile(abs(var_cellline), 0.75))], decreasing = TRUE)

# round variance to 5 digits
cellline_var_greater_75quantile <- round(cellline_var_greater_75quantile, digits = 5)

# create data frame with cell line names for top15 cell lines
celllines_top15 <- as.data.frame(names(cellline_var_greater_75quantile))

# add column with cancertype for top15 celllines
annotation_cancertype <- annotation[which(annotation[, "Drug"] == "erlotinib"), "Cancertype"]
names(annotation_cancertype) <- colnames(e_foldchange)
cancertypes_top15 <- sapply(names(cellline_var_greater_75quantile), function(x){
  annotation_cancertype[which(x == names(annotation_cancertype))]
})
table_celllines_var_top15 <- cbind(1:nrow(celllines_top15), celllines_top15, cellline_var_greater_75quantile, cancertypes_top15)

# change column and rownames of the table
colnames(table_celllines_var_top15) <- c("Rank", "Cellline", "Variance", "Cancertype")
rownames(table_celllines_var_top15) <- c(1:nrow(celllines_top15))

# load library formattable to create a table with our top 15 cell lines
library(formattable)
formattable(table_celllines_var_top15)
```


```{r message = FALSE, warning = FALSE, include = FALSE}
# draw PCA, where each point represents a cell line and is colored according to cancer type
pca <- prcomp(e_foldchange)
par(mar = c(4, 4, 4, 7))
plot(pca$rotation[,1], 
     pca$rotation[,2], 
     col = color_vector_cancertype, 
     pch = 19, 
     main = "PCA of cell lines",
     cex.main = 1.2,
     # get_eigenvalue is used to add percentage of explained variance in xlab and ylab
     # 2nd column of get_eigenvalue contains percentage of explained variance
     # round(x, digits to round): here round explained variance to one digit
     xlab = paste("PC1 (", round(get_eigenvalue(pca)[1, 2], 1), "%)"), 
     ylab = paste("PC2 (", round(get_eigenvalue(pca)[2, 2], 1), "%)"))

# add legend to associate each color with a cancertype
legend("topright", 
       legend = names(color_palette_cancertype), 
       col = color_palette_cancertype, 
       pch = 19, 
       xpd = TRUE, 
       inset = c(-0.18, 0))

# label cell lines, whose PC1 rotation value is greater than 0.14, representing the most divergent cell lines
celllines_PCA <- names(pca$rotation[ , 1])[pca$rotation[ , 1] > 0.14]
text(pca$rotation[ , 1][celllines_PCA], 
     pca$rotation[ , 2][celllines_PCA], 
     celllines_PCA,
     pos = 2,
     cex = 0.6)
```


 

```{r include = FALSE}
# assign genes to pathways (as in supplementary material)
MAPK <- c("AURKA", "AURKB", "SON", "CENPA", "KIF11", "DUSP6", "TPX2", "EGR1")
AKT_PI3K <- c("CFLAR", "XIAP", "BIRC5", "BIRC3", "GADD45A", "MCL1", "BCL2", 
              "BCL2L1", "HIF1A", "AR", "STAT3", "IL6", "JUN", "FOS")
  # AP1 for AKT_PI3K excluded (genename does not exist in FC)
  # same problem for VEGF
Cell_Cycle_Checkpoint <- c("CHEK1", "CHEK2", "TP53", "MDM2", "CDKN1A", "CCNE1", "CDK2", 
                           "CDC25A", "SMC1A", "CCNB1", "CDK1", "CDC25B", "CDC25C", 
                           "PLK1", "WEE1", "CCND1")
JAK_STAT <- c("SOCS1", "NMI", "BCL2L1", "CDKN1A", "MYC")
Immunity_Related <- c("BCL2L1", "XIAP", "BIRC5", "CFLAR", "IL6", "IL1B", "TNF")
  # PTGS does not exist
DNA_repair <- c("XRCC6", "PRKDC", "DCLRE1C", "XRCC4", "LIG4", "BRCA1", 
                "RAD52", "BRCA2", "RAD54L", "ATM", "ATR", "PARP1")
  # NHEJ1 does not exist
DNA_damage <- c("TP53", "FAS", "BAX", "PMAIP1")
  # BBC3 & ARG do not exist
ER_Stress_Survival <- c("HSPA5", "HSP90B1", "XBP1", "P4HB", "ATF4", "GADD45A")
ER_Stress_Apoptotic_Response <- c("ATF3", "DDIT3", "TNFRSF10B", "TRIB3", "BCL2L11", "CASP2")
  # BBC3 & GADD34 do not exist
Apoptosis_extrinsic_activation <- c("BID", "FAS", "CASP8", "CASP9", "APAF1")
Apoptosis_intrinsic_activation <- c("BAX", "BAK1", "BID", "PMAIP1", 
                                    "CASP6", "CASP9", "APAF1")
  # BBC3 does not exist
Autophagy_recycling_starvation <- c("MAP1LC3B", "ULK1", "ATG13", "BECN1", 
                                    "SQSTM1", "ATG5", "ATG12", "CTSB")
Autophagy_toxic <- c("SQSTM1", "ATG7", "RIPK1", "CTSB")

# create named list of all pathways
pathways <- list(MAPK = MAPK, 
                 AKT_PI3K = AKT_PI3K, 
                 Cell_Cycle_Checkpoint = Cell_Cycle_Checkpoint, 
                 JAK_STAT = JAK_STAT,
                 Immunity_Related = Immunity_Related,
                 DNA_repair = DNA_repair,
                 DNA_damage = DNA_damage,
                 ER_Stress_Survival = ER_Stress_Survival,
                 ER_Stress_Apoptotic_Response = ER_Stress_Apoptotic_Response,
                 Apoptosis_extrinsic_activation = Apoptosis_extrinsic_activation, 
                 Apoptosis_intrinsic_activation = Apoptosis_intrinsic_activation, 
                 Autophagy_recycling_starvation = Autophagy_recycling_starvation,
                 Autophagy_toxic = Autophagy_toxic) 
rm(MAPK, AKT_PI3K, Cell_Cycle_Checkpoint, JAK_STAT, Immunity_Related, DNA_repair, 
   DNA_damage, ER_Stress_Survival, ER_Stress_Apoptotic_Response, 
   Apoptosis_extrinsic_activation, Apoptosis_intrinsic_activation, 
   Autophagy_recycling_starvation, Autophagy_toxic)
```


```{r include = FALSE}
# calculate mean FC over genes of one pathway for each sample
# heatmap_data: 59 rows (samples), 13 columns (pathways)
heatmap_data <- sapply(1:length(pathways), function(x){ #for each pathway
  sapply(1:ncol(e_foldchange), function(y){ #for each cell line
    #calculate mean FC of genes of one pathway
    mean(e_foldchange[pathways[[x]], y]) 
  })
})

# change colnames to the names of the pathways and rownames to the names of the cell lines 
colnames(heatmap_data) <- c(names(pathways))
rownames(heatmap_data) <- colnames(e_foldchange)
```


```{r,  fig.height = 3, warning = FALSE, message = FALSE, include = FALSE}
# draw elbow plot to get optimal number of cell line clusters
library(factoextra)
fviz_nbclust(heatmap_data, 
             FUN = hcut, 
             method = "wss") + #within cluster sums of squares
  labs(title = "Elbow plot: optimal number of cell line clusters")

# draw elbow plot to get optimal number of pathway clusters
fviz_nbclust(t(heatmap_data), 
             FUN = hcut, 
             method = "wss") +
  labs(title = "Elbow plot: optimal number of pathway clusters")
```

```{r, fig.height = 6, warning = FALSE, include = FALSE}
# load pheatmap and the color palette RcolorBrewer
library(pheatmap)
library(RColorBrewer)

# change annotation matrix into a data fram
annotation_cancertype_df <- as.data.frame(annotation_cancertype)
colnames(annotation_cancertype_df) <- "Cancertypes"

# scale pathways
heatmap_data <- scale(heatmap_data, scale = TRUE)

# color according to quantiles
# save quantiles from 0 - 100% in steps of 20%, used for defining the color breaks for 5 different colors
color_quantiles <- quantile(heatmap_data, seq(0, 1, 0.2))

# generate heatmap with colored bars according to clusters
pheatmap(t(heatmap_data),
         clustering_method = "ward.D2",
         annotation_col = annotation_cancertype_df,
         cutree_rows = 3, # makes white spaces between clusters
         cutree_cols = 3,
         main = "Affected pathways by erlotinib",
         mainsize = 1.2,
         show_colnames = FALSE,
         cellwidth = 4,
         cellheight = 15, 
         fontsize = 10,
         fontsize_row = 12,
         breaks = color_quantiles,
         col = rev(brewer.pal(5, "RdBu"))) # 5 colors from "RdBu" color palette
```

```{r warning = FALSE, include = FALSE}
# load progeny
library(progeny)

# create progeny heatmap with the fold change of all genes in all cell lines
progeny_heatmap <- progeny(e_foldchange)
```


```{r, fig.height = 3, warning = FALSE, include = FALSE}
# draw elbow plot to get optimal number of cell line clusters
library(factoextra)
fviz_nbclust(progeny_heatmap, 
             FUN = hcut, 
             method = "wss") + #within cluster sums of squares
  labs(title = "Elbow plot: optimal number of cell line clusters")

# draw elbow plot to get optimal number of pathway clusters
fviz_nbclust(t(progeny_heatmap), 
             FUN = hcut, 
             method = "wss") +
  labs(title = "Elbow plot: optimal number of pathway clusters")
```

```{r warning = FALSE, fig.height = 6, message = FALSE, include = FALSE}
# load dendextend
library(dendextend)

# create matrix called "cellline_clusters", with one column for cell line, cancer type and cluster number, to which the cell line belongs to in the heatmap
cellline_clustering <- hclust(dist(progeny_heatmap), method = "ward.D2")
cellline_groups <- as.data.frame(cutree(tree = as.dendrogram(cellline_clustering), k = 2))
cellline_clusters <- as.data.frame(cbind(cellline_groups, annotation_cancertype_df))
colnames(cellline_clusters) <- c("Cellline cluster", "Cancertype cluster")

# Color according to quantiles
color_quantiles <- quantile(progeny_heatmap, seq(0, 1, 0.2))

# generate heatmap with colored bars according to clusters
par(mar = c(8, 2, 2, 2))
pheatmap(t(progeny_heatmap),
         clustering_method = "ward.D2",
         annotation_col = annotation_cancertype_df,
         cutree_rows = 2, #make white space between the different clusters
         cutree_cols = 2,
         main = "Affected pathways by erlotinib (PROGENy)",
         mainsize = 1.2, 
         show_colnames = FALSE,
         cellwidth = 5,
         cellheight = 20, 
         fontsize = 10,
         fontsize_row = 14,
         breaks = color_quantiles,
         col = rev(brewer.pal(5, "RdBu")))
```


### Venn Diagramm 

```{r message = FALSE, warning = FALSE, echo = FALSE}
# load package VennDiagram
library(VennDiagram)

# create vector, with cell lines of the second cluster from the PROGENy heatmap
heatmap_celllines_cluster2 <- rownames(cellline_clusters)[which(cellline_clusters[, 1] == 2)] 

# create list with cell lines of all three methods
venn.list <- list("Heatmap Cluster 2" = heatmap_celllines_cluster2,
                  "Top15 variance" = table_celllines_var_top15[, 2], 
                  "PCA" = celllines_PCA)

# draw venn diagram with cell lines of the highest variance table, PCA and heatmap cluster
venn.plot <- venn.diagram(
  x = venn.list,
  filename = NULL, 
  fill = c("blue", "red", "green"), 
  main = "Venn Diagramm of most regulated cell lines", 
  main.fontface = 2,
  main.cex = 1.2,
  main.fontfamily = "sans", # font type of title is Arial 
  cat.fontfamily = "sans",
  cat.cex = 0.9,
  fontfamily = "sans",
  cat.just = list(c(0.5, -40), c(0.2, -1), c(0,0)));
grid.draw(venn.plot);

# create vector, with ten cell lines of intersection
celllines_overlap <- calculate.overlap(venn.list)[[1]] 
```

### Principal Component Analysis
```{r}
pca <- prcomp(e_foldchange)
```

```{r message = FALSE, warning = FALSE, echo = FALSE}
# draw PCA, where each point represents a cell line and is colored according to cancer type

par(mar = c(4, 4, 4, 7))
plot(pca$rotation[,1], 
     pca$rotation[,2], 
     col = color_vector_cancertype, 
     pch = 19, 
     main = "PCA of cell lines",
     cex.main = 1.2,
     # get_eigenvalue is used to add percentage of explained variance in xlab and ylab
     # 2nd column of get_eigenvalue contains percentage of explained variance
     # round(x, digits to round): here round explained variance to one digit
     xlab = paste("PC1 (", round(get_eigenvalue(pca)[1, 2], 1), "%)"), 
     ylab = paste("PC2 (", round(get_eigenvalue(pca)[2, 2], 1), "%)"))

# add legend to associate each color with a cancertype
legend("topright", 
       legend = names(color_palette_cancertype), 
       col = color_palette_cancertype, 
       pch = 19, 
       xpd = TRUE, 
       inset = c(-0.18, 0))

# label cell lines, whose PC1 rotation value is greater than 0.14, representing the most divergent cell lines
celllines_PCA <- names(pca$rotation[ , 1])[pca$rotation[ , 1] > 0.14]
text(pca$rotation[ , 1][celllines_PCA], 
     pca$rotation[ , 2][celllines_PCA], 
     celllines_PCA,
     pos = 2,
     cex = 0.6)
```

### PROGENy

```{r warning = FALSE}
# load progeny
library(progeny)

# create progeny heatmap with the fold change of all genes in all cell lines
progeny_heatmap <- progeny(e_foldchange)
```

### Heatmap according to pathways
```{r warning = FALSE, fig.height = 6, message = FALSE, include = FALSE}
# load dendextend
library(dendextend)

# create matrix called "cellline_clusters", with one column for cell line, cancer type and cluster number, to which the cell line belongs to in the heatmap
cellline_clustering <- hclust(dist(progeny_heatmap), method = "ward.D2")
cellline_groups <- as.data.frame(cutree(tree = as.dendrogram(cellline_clustering), k = 2))
cellline_clusters <- as.data.frame(cbind(cellline_groups, annotation_cancertype_df))
colnames(cellline_clusters) <- c("Cellline cluster", "Cancertype cluster")
```

```{r warning = FALSE, fig.height = 6, message = FALSE}
# Color according to quantiles
color_quantiles <- quantile(progeny_heatmap, seq(0, 1, 0.2))

# generate heatmap with colored bars according to clusters
par(mar = c(8, 2, 2, 2))
pheatmap(t(progeny_heatmap),
         clustering_method = "ward.D2",
         annotation_col = annotation_cancertype_df,
         cutree_rows = 2, #make white space between the different clusters
         cutree_cols = 2,
         main = "Affected pathways by erlotinib (PROGENy)",
         mainsize = 1.2, 
         show_colnames = FALSE,
         cellwidth = 5,
         cellheight = 20, 
         fontsize = 10,
         fontsize_row = 14,
         breaks = color_quantiles, # coloring according to calculated quantiles
         col = rev(brewer.pal(5, "RdBu")))
```


##   _**3. Milestone: Identify biomarkers**_

### Select biomarkers with high fold change and high significance

```{r message = FALSE, warning=FALSE,fig.show="hide", echo = FALSE}
# load ggplot2 and ggrepel
library(ggplot2)
library(ggrepel)

# create data frame with variables M and A of MA-plot as well as one column, which shows, if absolute fold change is greater than 0.25 
# M = log2(treated) - log2 (untreated)
M <- e_foldchange 
# average log2-expression value A = 1/2 (log2(treated)+log2(untreated))
A <- 0.5 * (e_treated + e_untreated) 
MA <- cbind("M" = rowMeans(M), "A" = rowMeans(A))
rm(M, A)
MA <- as.data.frame(MA)
MA$High_foldchange <- ifelse(MA$M > 0.25 | MA$M < -0.25, "FC_abs > 0.25", "FC_abs < 0.25")

# label genes of MA plot, which have an absolute foldchange greater than 0.5 
MA_labeled <- MA[which(abs(MA[ , "M"]) > 0.5) , ]

# create MA plot, where genes with FC_abs > 0.25 are colored and those genes with FC_abs > 0.5 are labeled
ggplot(data = MA)+ 
  aes(x = A, y = M, color = High_foldchange)+
  geom_point()+
  xlab("average log2 expression")+
  ylab("log fold change")+
  ggtitle("MA plot of all genes")+
  geom_text(data = MA_labeled, aes(A, M, label = rownames(MA_labeled)), hjust = 0, nudge_x = 0.1)+
  # change the size and face (bold) of the title and center it (hjust = 0.5)
  theme(plot.title = element_text(size = 13, face = "bold", hjust = 0.5)) 

#save highlighted biomarkers, obtained through MA plot in biomarkers_MA
biomarkers_MA <- rownames(MA)[which(abs(MA$M) > 0.25)]
```

 
```{r warning = FALSE, message = FALSE, echo = FALSE}
# load libraries needed for EnhancedVolcano
library(ggplot2)
library(ggrepel)
library(EnhancedVolcano)

# calculate mean foldchange over all cell lines for each gene
e_foldchange_mean_over_cell_lines <- rowMeans(e_foldchange) 
```
 
```{r warning = FALSE, message = FALSE}

# determine p-value for a paired two-sample t-test between gene expression of treated and untreated samples
p_values <- sapply(rownames(e_treated), function(x) {
  # perform t-test and save p-values of each gene in p_values-vector
  t.test(e_treated[x,], e_untreated[x,],paired = T)$p.value}) 

# calculate FDR with benjamini-hochberg (BH)
FDR_values <- p.adjust(p_values, method = "BH", n = length(p_values)) 
```

```{r warning = FALSE, message = FALSE, echo = FALSE}

# create matrix with one column for mean foldchange and one column for FDR_values for every gene
volcano_plot_mat <- cbind(e_foldchange_mean_over_cell_lines, FDR_values)

# draw volcano plot, where those genes with FC_abs > 0.25 and FDR_value > 10e^-9 are labeled and highlighted in red 
EnhancedVolcano(volcano_plot_mat, 
                lab = rownames(volcano_plot_mat),
                x = "e_foldchange_mean_over_cell_lines", 
                y = "FDR_values",
                title = "Volcano plot of all genes",
                titleLabSize = 13,
                ylab = bquote(~FDR~value),
                pCutoff = 10e-9, # threshold for coloring significant ones
                FCcutoff = 0.25, # threshold for coloring high FC
                transcriptPointSize = 2,
                transcriptLabSize = 3,
                legendPosition = "right",
                legendLabSize = 10,
                axisLabSize = 10)

# save highlighted biomarkers, obtained through volcano plot in biomarkers_volcano
biomarkers_volcano <- rownames(volcano_plot_mat)[which(abs(volcano_plot_mat[ , 1]) >  0.25  
                                                       & volcano_plot_mat[ , 2] < 10e-9)]
```


##   _**4. Milestone - Does the gene expression correlate with the drug sensitivity?**_

```{r, echo = FALSE}
# create vector of NegLogGI50 of erlotinib, which only includes cell lines, which also appear in e_foldchange
NegLogGI50_59_celllines <- NegLogGI50 ["erlotinib", -c(8,29)] # remove cell line "COLO-205" and "MDA-N"

# multiply the NegLogGI5 = by -1 to get the LogGI50-values
LogGI50_59_celllines <- NegLogGI50_59_celllines * (-1)


# change colnames of e_untreated with cell line instead of complete sample name
colnames(e_untreated) <- cellline

# create color vector to color erlotinib treated cell lines according to cancertype
e_color_cancertype <- color_vector_cancertype[grep("erlotinib", names(color_vector_cancertype), value = TRUE)]
```


### EGR1 fold change against GI50-values 


```{r figEGR1 , fig.show = "hold",  fig.width = 7, fig.height = 7, warning = FALSE,  message = FALSE, echo = FALSE}

# draw scatter plot of fold change of EGR1 against LogGI50 and color them according to the cancer type
par(mar = c(4, 4, 4, 10), xpd = "TRUE")
plot(LogGI50_59_celllines, e_foldchange ["EGR1",], 
     col = e_color_cancertype, 
     pch = 19, 
     xlab = "logGI50", 
     ylab = "Fold change of EGR1 Expression",        
     main = "Erlotinib 24h", 
     cex.main = 1.2, 
     col.main = "deepskyblue")

# add legend to associate each color with a cancertype
segments(-7.11, 0, -3.88)
legend("topright", 
       legend = names(color_palette_cancertype), 
       col = color_palette_cancertype, 
       inset = c(-0.3, 0),
       pch = 19)


# label cell lines, which are most sensitive and have a very low fold change of EGR1 
labeled_celllines <- names(LogGI50_59_celllines)[LogGI50_59_celllines < - 6
                                                        & e_foldchange["EGR1", ] < 0 
                                                 | LogGI50_59_celllines < -5 
                                                        & e_foldchange["EGR1", ] < -3]
text(LogGI50_59_celllines[labeled_celllines], e_foldchange ["EGR1", labeled_celllines],
     labels = labeled_celllines,
     cex = 0.7,
     pos = 4)

# add linear regression line and set clipping limit
clip(-7.13, -3.88, -2, 0.5)  
abline(lm (e_foldchange["EGR1", ]~ LogGI50_59_celllines))

# perform Pearson correlation, to see how well LogGI50 and the fold change correlate with each other 
cor_EGR1 <- cor.test(LogGI50_59_celllines, e_foldchange["EGR1",], method = "pearson")
cor_EGR1_estimate <- round(cor_EGR1$estimate, digits = 3)

# add title to scatter plot, which includes the correlation value
cor_text <- paste("r = ", cor_EGR1_estimate, "(***)")
mtext(side = 3, line = -1.2, text = cor_text, adj = c(0.01))

```

```{r}
# perform Pearson correlation, to see how well LogGI50 and the fold change correlate with each other 
cor_EGR1 <- cor.test(LogGI50_59_celllines, e_foldchange["EGR1",], method = "pearson")
```


##   _**5. Milestone - final results**_

### Select final cell lines according to GI50 correlation

```{r message = FALSE, echo = FALSE}
library(VennDiagram)
# save the names of the 10 most erlotinib-sensitive cell lines (highest LogGI50)
LogGI50_top10 <- names(sort(LogGI50_59_celllines)[1:10])
# Venn diagram to compare cell lines from Milestone 2 with the ones with highest sensitivity
venn.plot <- venn.diagram(
  x = list(
    "Overlap of variance, 
    PCA and heatmap cell lines" = celllines_overlap,
    "Top 10 LogGI50" = LogGI50_top10),
  filename = NULL, 
  fill = c("blue", "red"), 
  main = "Venn Diagramm of most regulated cell lines", 
  main.fontface = 2,
  main.cex = 1.2,
  main.fontfamily = "sans", # font type of title is Arial 
  cat.fontfamily = "sans", # font type of labels
  cat.cex = 0.9,
  fontfamily = "sans", 
  cat.just = list(c(0.2,-1.5), c(1.2,-4))); #change position of the labels
grid.draw(venn.plot);

#save the 7 cell lines from the intersection
celllines_final <- intersect(celllines_overlap, LogGI50_top10)

```

```{r}
#save the 7 cell lines from the intersection
celllines_final <- intersect(celllines_overlap, LogGI50_top10)
```

### Select final biomarkers according to GI50 correlation

```{r}
# create vector, which contains the GI50 - fold change correlation value for all genes
cor_all_genes <- sapply(rownames(e_foldchange), function(x){
  cor_test_one_gene <- cor.test(LogGI50_59_celllines, e_foldchange[x,], method = "pearson")
  cor_test_one_gene$estimate
})
```

```{r}
# sort genes according to decreasing correlation value and select 500 genes with the highest correlation value
cor_all_genes_sorted <- sort(abs(cor_all_genes), decreasing = TRUE)
cor_top_500_genes <- cor_all_genes_sorted[1:500]
```

```{r, echo = FALSE}
# create vector, which contains the GI50 - fold change correlation value for all genes
cor_all_genes <- sapply(rownames(e_foldchange), function(x){
  cor_test_one_gene <- cor.test(LogGI50_59_celllines, e_foldchange[x,], method = "pearson")
  cor_test_one_gene$estimate
})
# sort genes according to decreasing correlation value and select 500 genes with the highest correlation value
cor_all_genes_sorted <- sort(abs(cor_all_genes), decreasing = TRUE)
cor_top_500_genes <- cor_all_genes_sorted[1:500]

# create vector, which contains the GI50 - fold change correlation value for the volcano biomarkers
cor_biomarkers <- sapply(biomarkers_volcano, function(x){
  cor_test_one_biomarker <- cor.test(LogGI50_59_celllines, e_foldchange[x,], method = "pearson")
  cor_test_one_biomarker$estimate
})

# plot venn diagram to find biomarkers, which belong to the volcano biomarkers and to the 500 genes with highest GI50 correlation value 
par(oma = c(2, 2, 2, 2))
biomarkers_MA_vector <- rownames(MA_labeled)
venn.plot <- venn.diagram(
  x = list(
    "500 genes with highest correlation" = names(cor_top_500_genes),
    "correlation of biomarkers" = names(cor_biomarkers)),
  filename = NULL, 
  fill = c("blue", "red"), 
  main = "Venn Diagramm of genes with highest GI50-foldchange correlation compared to biomarkers", 
  main.fontface = 2,
  main.cex = 1.2,
  main.fontfamily = "sans", # font type of title is Arial 
  cat.fontfamily = "sans",
  cat.cex = 0.9,
  ext.text = FALSE,
  fontfamily = "sans",
  cat.pos = c(0,0));
grid.draw(venn.plot);

# save final biomarkers, which are in intersect of volcano biomarkers and cor_top_500_genes
biomarkers_final <- intersect(names(cor_top_500_genes), names(cor_biomarkers))
biomarkers_final <- gsub(pattern = ".cor", replacement = "", x = biomarkers_final)
```

### Compare gene expression of final biomarkers 
```{r, echo = FALSE}
# create matrix only with gene expression of untreated and treated final biomarkers
e_untreated_biomarkers_final <- sapply(biomarkers_final, function(x){
  e_untreated[x, ]
}) 
e_treated_biomarkers_final <- sapply(biomarkers_final, function(x){
  e_treated[x, ]
})

# add "treated" to colnames of gene expression of treated biomarkers to distinguish them from untreated in a common matrix
colnames(e_treated_biomarkers_final) <- paste(colnames(e_treated_biomarkers_final),"Treated",sep = "_") 

# create matrix, which contains gene expression of untreated and treated 
e_treated_untreated_biomarkers_final <- cbind (e_treated_biomarkers_final, e_untreated_biomarkers_final)

# sort matrix according to colnames that treated and untreated gene expression of the same gene are next to each other
e_treated_untreated_biomarkers_final <- e_treated_untreated_biomarkers_final[,order(colnames(e_treated_untreated_biomarkers_final))]

# create color vector, where untreated samples are green and treated ones are red
color_boxplot_e_treated_untreated <- sapply(colnames(e_treated_untreated_biomarkers_final), function(x) {
  ifelse(x %in% grep ("Treated",colnames(e_treated_untreated_biomarkers_final), value = TRUE),"red", "green")})

# draw boxplot, where treated and untreated are right next to each other
par(mar = c(16, 4, 2, 2))
boxplot(e_treated_untreated_biomarkers_final, 
        ylab = "gene expression (log2)", 
        main = "Boxplot of gene expression of the biomarkers", 
        ceex = 1.2, 
        las = 2, 
        col = color_boxplot_e_treated_untreated)
```

### Single gene response plot 

```{r message = FALSE, warning = FALSE, echo = FALSE}
#comparison with lapatinib
# new matrix only with samples treated with lapatinib  (l = lapatinib)
l_treated <- NCI_TPW_gep_treated[ ,grep ("lapatinib", colnames(NCI_TPW_gep_treated))]
l_untreated <- NCI_TPW_gep_untreated[ ,grep ("lapatinib", colnames(NCI_TPW_gep_treated))]

# normalise matrix with scale 
l_treated <- scale(l_treated, scale = TRUE)
l_untreated <- scale(l_untreated, scale = TRUE)

# change colnames according to their cell line instead of their complete sample name
cellline <- sapply(colnames(l_treated), function(x){
  annotation[x,"Cellline"]
  }) 
colnames(l_treated) <- cellline
colnames(l_untreated) <- cellline

# calculate foldchange by substracting e_untreated from e_treated
l_foldchange <- l_treated - l_untreated

lapatinib_ERCC6L <- l_foldchange[biomarkers_final[1], celllines_final]


# create data frame, with one column for the foldchange of each biomarker in the final cell lines
df_barplot_results <- as.data.frame(sapply (biomarkers_final, function(x) {
  e_foldchange[x, celllines_final]
}))

# add one column for the cell line and one for the cancer type of the cell line
df_barplot_results <- as.data.frame(cbind(cellline = celllines_final, annotation_cancertype_df[celllines_final, ], df_barplot_results, lapatinib_ERCC6L = lapatinib_ERCC6L))
colnames(df_barplot_results)[2] <- "Cancertypes" #change colname of cancer type column

# sort cell lines according to cancer type
df_barplot_results <- df_barplot_results [order(df_barplot_results[,"Cancertypes"]),]


```

```{r message = FALSE, warning = FALSE, echo= FALSE}

# create barplot for each gene and color according to cancer type
plot <- lapply(colnames(df_barplot_results)[3:8], function(gene){
  ggplot_title <- paste("Foldchange of" , gene)
  ggplot(data = df_barplot_results, aes(x = cellline, y = df_barplot_results[ ,gene], fill = Cancertypes)) +
    geom_bar(stat = "identity")+
    scale_fill_manual(values = c("aquamarine", "forestgreen", "chartreuse", 
                               "cadetblue","purple", 
                               "firebrick1", "deepskyblue"))+
    ggtitle(paste0 (ggplot_title, "\n"))+
    theme(axis.title.x = element_blank())+
    theme(axis.title.y = element_blank())+
    scale_x_discrete(limits = rownames(df_barplot_results))+
    coord_flip()
})

```

```{r message = FALSE, warning = FALSE, echo= FALSE}

# load ggpubr
library(ggpubr)
# draw all five barplots next to each other
ggarrange( plot[[2]], plot[[3]], plot[[4]], plot[[5]], plot[[1]], plot[[6]],
          ncol = 2, nrow = 3, common.legend = TRUE, legend = "top")
```


